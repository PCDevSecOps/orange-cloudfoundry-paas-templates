- type: replace
  path: /instance_groups/name=k8s-helm-addons/jobs/name=action/properties/actions/-
  value:
    type: secret
    name: grafana-admin-secret
    namespace: grafana
    data:
    - name: GF_SECURITY_ADMIN_USER
      value: admin
    - name: GF_SECURITY_ADMIN_PASSWORD
      value: ((grafanaAdminPassword))


- type: replace
  path: /instance_groups/name=k8s-helm-addons/jobs/name=action/properties/actions/-
  value:
    type: kubectl
    name: "certificate-grafana"
    cmd: "apply"
    options: ""
    content:
      apiVersion: ((certificate_api_version))
      kind: Certificate
      metadata:
        name: grafana-tls
        namespace: grafana
      spec:
        secretName: grafana-tls
        duration: 24h
        renewBefore: 12h
        commonName: grafana.((env_pf)).((/secrets/cloudfoundry_ops_domain))
        issuerRef:
          name: issuer
          kind: ClusterIssuer


- type: replace
  path: /instance_groups/name=k8s-helm-addons/jobs/name=action/properties/actions/-
  value:
    type: helm_chart
    name: grafana
    namespace: grafana
    chart: stable/grafana
    version: ((grafana-version))
    debug: true
    properties:

    - name: adminPassword
      value: ((grafanaAdminPassword))

    - name: envFromSecret
      value: grafana-admin-secret

    values_file_content:
      env:
        https_proxy: ((https_proxy))
        http_proxy: ((http_proxy))
        no_proxy: ((no_proxy))

      downloadDashboards:
        env:
          https_proxy: ((https_proxy))
          http_proxy: ((http_proxy))
          no_proxy: ((no_proxy))

      plugins:
      - digrich-bubblechart-panel
      - grafana-clock-panel
      - grafana-piechart-panel
      - vonage-status-panel
      - marcuscalidus-svg-panel
      - grafana-worldmap-panel
      - jdbranham-diagram-panel
      - btplc-status-dot-panel

      dashboardProviders:
        dashboardproviders.yaml:
          apiVersion: 1
          providers:
          - name: 'default'
            orgId: 1
            folder: ''
            type: file
            disableDeletion: false
            editable: true
            options:
              path: /var/lib/grafana/dashboards/default
      grafana.ini:
        paths:
          data: /var/lib/grafana/data
          logs: /var/log/grafana
          plugins: /var/lib/grafana/plugins
          provisioning: /etc/grafana/provisioning
        analytics:
          check_for_updates: true
        log:
          mode: console
        grafana_net:
          url: https://grafana.net
        auth.ldap:
          enabled: true
          allow_sign_up: true
          config_file: /etc/grafana/ldap.toml
      ldap:
        enabled: true
        existingSecret: "grafana-ldap"

      sidecar:
        dashboards:
          enabled: true
          searchNamespace: grafana
        datasources:
          enabled: true


- type: replace
  path: /variables?/-
  value:
    name: grafanaAdminPassword
    type: password
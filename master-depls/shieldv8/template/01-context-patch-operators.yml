#operators to adapt the community manifest to paas-templates context

#adapt stemcell
- type: replace
  path: /stemcells/0
  value:
    alias: default
    os: ubuntu-xenial
    version: latest

#adapt deployment name
- type: replace
  path: /name
  value: shieldv8

#adapt release, latest version for shield release
#- type: replace
#  path: /variables/name=shield-agent-key/type
#  value: rsa

#adapt release, add routing
- type: replace
  path: /releases/-
  value:
    name: routing
    version: latest

#- type: replace
#  path: /releases/-
#  value:
#    name: bpm
#    version: latest

- type: replace
  path: /releases/name=shield
  value:
    name: shield
    version: latest

- type: replace
  path: /variables?/-
  value:
    name: failsafe-password
    type: password

- type: replace
  path: /variables?/-
  value:
    name: token_name
    type: password

#adapt vm_types
- type: replace
  path: /instance_groups/name=shield/vm_type
  value: 1cpu-4g

#adapt vm_types
- type: replace
  path: /instance_groups/name=shield/persistent_disk
  value: 200000

#adapt network
- type: replace
  path: /instance_groups/name=shield/networks/0/name
  value: tf-net-exchange

#link
- type: replace
  path: /instance_groups/name=shield/jobs/name=core/provides/shield
  value: {shared: true, as: shield}

#log-level for core
- type: replace
  path: /instance_groups/name=shield/jobs/name=core/properties/log-level?
  value: ((log-level))

#failsafe password for core
- type: replace
  path: /instance_groups/name=shield/jobs/name=core/properties/failsafe?
  value:
    password: ((failsafe-password))

#add alternative_name
- type: replace
  path: /variables/name=shield-tls/options/alternative_names/-
  value: ((shield-alias))

#log-level for agent
- type: replace
  path: /instance_groups/name=shield/jobs/name=shield-agent/properties/log-level?
  value: ((log-level))

- type: replace
  path: /instance_groups/name=shield/jobs/name=shield-agent/consumes/shield?
  value: {from: shield, deployment: shieldv8 }

#add route registrar for shield deployment
- type: replace
  path: /instance_groups/name=shield/jobs/-
  value:
    name: route_registrar
    release: routing
    properties:
      nats:
        machines: [ops-routing-nats]
        password: ((/bosh-master/ops-routing/nats_password))
        user: nats
        port: 4222
      route_registrar:
        routes:
        - name: shieldv8-webui
          tls_port: 443
          server_cert_domain_san: '((shield-domain))'
          registration_interval: 20s
          uris:
            - ((shield-domain))

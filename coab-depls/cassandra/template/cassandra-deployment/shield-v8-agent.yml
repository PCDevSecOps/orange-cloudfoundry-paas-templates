---

- path: /releases/name=shield?
  type: replace
  value:
    name: shield
    version: latest


- path: /instance_groups/name=cassandra-seeds/jobs/-
  type: replace
  value: &shield_agent_job
    name: shield-agent
    release: shield
    consumes:
      shield: { from: shield, deployment: shield }
    properties:
      name: cassandra
      shield-url: https://((shield_domain))
      require-shield-core: false
      core:
        # You'll usually want this to be the certificate from your shield
        # deployment, in which case you can target it with:
        # ((/<bosh-director-name>/<shield-deployment-name>/shield-ca.certificate))
        ca: ((shield-ca.certificate))
      env:
        path:
          - /var/vcap/cassandra/job/bin

- path: /instance_groups/name=cassandra-servers/jobs/-
  type: replace
  value: *shield_agent_job

# add import job on cassandra-seeds instance groups
- path: /instance_groups/name=cassandra-seeds/jobs/-
  type: replace
  value: &config_shield
    name: import
    release: shield
    properties:
      generate_token: true
#     core: sandbox
      core: ((shield-url))
      domain: shield-webui-((deployment_name)).((/secrets/cloudfoundry_ops_domain))
#     domain: ((shield_domain))
      import:
        ca: ((/bosh-jra/shield-v8/shield-ca.certificate))
        core: ((shield-url))
        insecure_skip_verify: true
        token: ((shield-token))
        tenants:
        - name: ((shield-tenant))
          systems:
          - name: ((deployment_name))-(ip)
            agent: (name)-(index)-(ip):5444
#            agent: (ip):5444
            plugin: cassandra
            config:
              host: (ip)
              user: cassandra
              password: ((cassandra_admin_password))
              bindir: "/var/vcap/jobs/cassandra/bin"
              datadir: "/var/vcap/store/cassandra/((deployment_name))/data"
            jobs:policy:
            - name: (name)-(index)-(ip)-backup-test
              paused: true
             #policy: ((shield-retention))
              policy: 7d
              storage: ((shield-storage))
             #when: every 8 hours from 0:15
              when: hourly at 30
            plugin: cassandra
            summary: shield v8
          storage:
          - name:  ((shield-storage))
            summary: "Internal S3 cloud storage for all SHIELD tenants to use"
            agent:  ((shield-server)):5444
            plugin: s3
            config:
              s3_host: ((s3-host))
              s3_port: ((shield-port))
              access_key_id: ((s3-access-key))
              secret_access_key: ((s3-secret-key))
              bucket: ((s3-bucket)) #pre-requisite
              signature_version: ((aws-signature))
              skip_ssl_validation: ((skip-ssl-validation))


# add import job on cassandra-servers instance groups
- path: /instance_groups/name=cassandra-servers/jobs/-
  type: replace
  value: *config_shield



- path: /variables/-
  type: replace
  value:
    name: shield-ca
    type: certificate
    options:
      is_ca: true
      common_name: shieldca

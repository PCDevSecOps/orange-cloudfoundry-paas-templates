# V 46.0.2

## Release overview
## Security bumps
- stemcells
- rootfs
- buildpacks
- uaa

## Releases bumps
- cloudfoundry 12.28.0 
- cf ops automation 4.3, including:
    - bump terraform flexible engine to version 1.11 #308
    - quick overview of bosh release versions used by a root deployment #305
    - leverage icons to ease resource identification #304
    - multiple markers for iaas-type (~ profile tag) #79
    - concourse 5.8
- shield 8.6.3 
- dedicated redis 5.0.7
- traefik v2
- kubo 0.42.1
- osbcmdb 0.9.0


## Fix/Optimizations
- shared services 
    - cf-rabbit 37 : set operator policy instead of regular policy through cron    
    - harden not bosh.io releases

- dedicated services 
    - intranet proxy usage on backups (bucket creation and agents)
    - persistent disk usage instead of transient one in order to store backup inventory
    - prevent from unexpected no-op bosh updates triggering
    - harden not bosh.io releases

- backup
  - remove shieldv8 dependency on micro-depls

## New features
- core
  - COA profiles
  - initial support for multi-region- openstack
  - jcr bump 7.3.2 and automated configuration
- marketplace
  - osbcmdb improvements.
  - shared services
    - add the possibility to configure broker node instances through secrets file  
    - cloudfoundry-mysql and cloudfoundry-mysql-osb : set different backup schedule for each node    

  - dedicated services 
    - enable instances retrofit
    - change embedded shield exposition (now on internal.paas)
    - add cf-mysql xxlarge plan 
    - improve grafana dashboards - add the possibility to retrieve information by instance deployment name

- backup
    - mirroring architecture on shared shield (master-depls/shieldv8)  
    - enable bosh backup restore when it is possible (bosh, credhub-ha, cloudfoundry, cfcr-micro) 


## Cleaning
- remove master-depls/shield and dependencies

# Installation overview

## Conventions

- If Concourse jobs begins with `OPS-manually*`, its requires to perform a manual external task/check. This jobs is just a reminder for the step but no automated tasks are applied
- If Concourse jobs begins with `manual-step*`, you need to trigger this job manually to achieve following automated tasks

>**Note:**  
> Be careful, some `manual-step-xx` jobs are not correctly displayed in concourse webui. So you can check jobs name `step-x-xxxx` to clearly identify jobs order

## Load upgrade pipelines from pre-install branch
[//]: # (TODO pre-merge - Load upgrade pipelines from pre-install branch)

>**Note:**  
> For next operations, ensure you pushed your previous updates (if exists) in each repository before deleting it

1. Set pre-requisites on `operator local env` (your laptop)
- `~/bosh/secrets` => Up to date `secrets` clone from target environment you want to upgrade

  ```
  cd ~/bosh
  rm -fr secrets
  git clone <secrets_target_repo_url> secrets
  ```

- `~/bosh/template` => Up to date `paas-template` clone from <reference_repo_url> (`Orange forge` or `FE-INT`) containing **tagged version** to install

  ```
  cd ~/bosh
  rm -fr template
  git clone <reference_repo_url> template
  cd template
  ```

- Check that <tag_version> exists and is associated with HEAD commit.

  ```
  git fetch --tags
  git show HEAD <tag_version> 
  # If HEAD is not pointing at same commit than current branch, you may reset to the tag
  # Warning: this would remove more recent commits from current branch
  git reset --hard <tag_version>
  gitlog
  ```

2. Push reference branch to a new branch called `pre-install-v<tag_version>` on your target `gitlab` environment

    ```bash
    cd ~/bosh/template/upgrade
    ./publish-paas-template-into-local-gitlab-pipeline.sh # tag version is determined using meta-inf.yml, check script option to override
    ```

3. Switch to `docker-bosh-cli` and set pre-requisites

>**Note:**  
> For next operations, ensure you pushed your previous updates (if exists) in each repository before deleting it

- `~/bosh/template` => Up to date `paas-template` clone from target environment you want to upgrade, on branch `pre-install-v<tag_version>`

  ```
  cd ~/bosh
  rm -fr template
  git clone <template_target_repo_url> template
  cd template
  git checkout pre-install-v<tag_version>
  ```

- `~/bosh/secrets` => Up to date `secrets` clone from target environment you want to upgrade

  ```
  cd ~/bosh
  rm -fr secrets
  git clone <secrets_target_repo_url> secrets
  ```

4. Update `credhub` with `paas-template` and `coa` versions and load upgrade pipeline

    ```
    cd ~/bosh/template/upgrade
    ./update-upgrade-param.sh
    ./load-upgrade-pipeline.sh
    ```

5. Ensure concourse jobs (in `main` team) from `init-upgrade-pipelines` pipeline turn green before operating next step (`display-meta-inf` may need to be retriggered manually to turn green, if the update pipeline from previous version was not cleaned up). Check that the branch name is correct in the inputs of `reload-this-pipeline-from-git` and matches the pre-install branch name (version to install) 

## Bump Cf-Ops-Automation
[//]: # (TODO pre-merge - Bump Cf-Ops-Automation)

0. Protect unmanaged bosh deployments from COA automatic cleanup 

  >**/!\ Reminder** 
  > Since version 4.2.0, COA implements a new delete mechanism that synchronizes bosh deployments and secrets repository declaration.
  > Every bosh deployments must be declared in secrets repository, otherwise bosh deployments are going to be deleted.
  > To avoid deletion, a bosh deployment that was not managed by paas-templates must be `protected` by creating an empty file called `protect-deployment.yml` as below

    ```bash
    #Step 1: identify unmanaged bosh deployments in each bosh director
    log-bosh
    bosh deployments
    
    #For each identified unmanaged bosh deployment, protect it if the deployment should be preserved
    cd ~/bosh/secrets/
    touch ops-depls/my-prototype-bosh-deployment/protect-deployment.yml
    git add ops-depls/my-prototype-bosh-deployment/protect-deployment.yml
    git commit -m "protect unmanaged bosh deployment" && git push
    ``` 

1. Bump `cf-ops-automation` to `4.3.2` version on `gitlab` to your target environment (if needed)

  >**Note:**  
  > This operation is useful for when Cf-Ops-Automation is mirrored on `local gitlab`, or when your COA version does not match expected version. If fetched from github (see secret config below), this step can be skipped
    
    ```
    $ grep cf-ops-automation-uri ~/bosh/secrets/coa/config/credentials-git-config.yml 
    cf-ops-automation-uri: https://github.com/orange-cloudfoundry/cf-ops-automation.git
    ```

    ```bash
    cd ~/bosh
    rm -fr coa
    proxy
    git clone -b master https://github.com/orange-cloudfoundry/cf-ops-automation.git ~/bosh/coa
    proxy
    cd ~/bosh/coa
    git reset --hard v4.3.2
    gitlog
    git remote add gitlab '<coa_gitlab_repo_url>'
    git push -f --tags gitlab master
    ```

2. Ensure concourse jobs (in `main` team) from `init-upgrade-pipelines` pipeline turn green before operating next step (`display-meta-inf` may need to be retriggered manually to turn green, if the update pipeline from previous version was not cleaned up)

3. Trigger `coa-v*-upgrade / WARNING-This-pipeline-updates-secrets-repository` concourse job, and ensure steps turn green before operating next step

- If some concourse jobs turn orange (erroring due to race condition between builds triggered shared/secrets, and COA 4.3 updated pipelines), then trigger manually failed jobs

> sample error that can be observed in `master-depls-bosh-generated/jobs/cloud-config-and-runtime-config-for-master-depls`
> task config 'cf-ops-automation/concourse/tasks/bosh_update_cloud_config.yml' not found

## Bump paas-template
[//]: # (TODO - MERGE paas-templates bump)

  >**Notes:**  
  > - If `reference` branch is protected on `gitlab` you must unprotect it before triggering following job, and protect it when it ended.
  >    - connect to gitlab with root account using standard IDP (i.e. not ldap IDP) See `micro-depls/gitlab/secrets/README.md` for associated credentials. Use the menu `Settings->Repository->Protected Branches`
  > - During this step, some jobs are paused in the different pipelines to allow upgrade process  
  > Pausing pipelines induces on demand service provisioning unavailability (eg: new COAB or Cloudflare services can't be created while concourse is paused: they will fail with a user-facing timeout)

- Trigger `paas-templates-*-upgrade / WARNING-This-pipeline-updates-secrets-repository` concourse job, and ensure automated steps turn green before operating next step

### Synchronize paas-template to local gitlab (OPS-manually-synchronize-paas-template-to-local-gitlab)
[//]: # (TODO - pre-merge manual ops steps and push release)

1. Check [detailed content](#version-detailed-content) section below to apply related secrets steps in `Manual platform ops pre-merge steps` section, with `TODO pre-merge` tag.  

2. Now you need to push new paas-templates release to the tenant gitlab.  
Use `upgrade-to-paas-templates-* / promote-pre-install-to-reference` job before triggering `OPS-manually-synchonize-paas-template-to-local-gitlab` job

>**Caution:**  
> This `promote-pre-install-to-reference` job needs to be triggered `before` manually triggering the `OPS-manually-synchonize-paas-template-to-local-gitlab` job  
> It sets `reference` branch with target content (don't use if your main branch is called differently)

Protect back the `reference` branch in gitlab (`no-one` should be able to push and merge). 

Check that `paas-templates-xx-upgrade/reset-paas-templates-WIP-to-reference` turns green (this prepares the next step "rebase XX branches")

### Rebase COAB instances branches (OPS-manually-rebase-coab-branches)
[//]: # (TODO post-merge - rebase COAB instances branches)

See procedure at https://github.com/orange-cloudfoundry/paas-templates/issues/304 to be applied on paas-template repository  
You can also use `admin/rebase-paas-templates-branches.sh` script

```bash
cd ~/bosh/template/admin
./rebase-paas-templates-branches.sh -h # to understand option available, the script ask for confirmation before overriding remote branch
./rebase-paas-templates-branches.sh -s reference -p <gitlab_url> -b "*serviceinstances" -f
```
When every COAB branches are rebased, you can trigger `paas-templates-xx-upgrade/OPS-manually-rebase-coab-branches` 

### Rebase custom branches (OPS-manually-rebase-custom-branches)
[//]: # (TODO post-merge - rebase custom branches)
You can use `admin/rebase-paas-templates-branches.sh` script, without `-b ...` (it will process all feature branches except one containing `coab`)

```bash
cd ~/bosh/template/admin
./rebase-paas-templates-branches.sh -s reference -p <gitlab_url> -f
```

Manually trigger `sync-feature-branches/jobs/apply-merged-wip-features-reset` if `sync-feature-branches/jobs/update-merged-wip-features` is still failing 

When every custom branches are rebased, you can trigger `paas-templates-xx-upgrade/OPS-manually-rebase-custom-branches`

### Check and fix updated secrets (OPS-manually-check-and-fix-updated-secrets)
[//]: # (TODO pre-upgrade - Check and fix updated secrets, and apply manual steps)

>**Note**:  
> During automatic upgrade comments in secrets files are **LOST** (if you want to keep them, use below syntax)

```bash
  site_comment: "#--- Tenant identification"
  site: fe-prod

  #--- Bosh directors
  bosh_comment: "#--- Bosh directors"
  bosh:
```

Most secrets updates are automated (see `Pipeline Automated` tag on each manual ops step), but some of them still requires manual updates.  

1. During upgrade process, some secrets key are initialized, but you have to set the associated value.
You can identify secrets that need to be set with following command (from `docker-bosh-cli`)

    ```bash
    cd ~/bosh/secrets
    git pull --rebase
    f "FIXME - REQUIRED" | grep -v "/coa/pipelines"
    ```
2. Ensure a Github access token is provided. Key `bot-github-access-token` must be set, with a valid value, in `~/bosh/secrets/coa/config/credentials-git-config.yml`.
If missing, you need to : 
- visit `https://github.com/settings/tokens` as an authenticated github user,
- generate a new token: 
    * set note to "Used by COA to get github releases", and does not select anything
    * click "generate token" at bottom
    * save the token and set it to  `bot-github-access-token` in `~/bosh/secrets/coa/config/credentials-git-config.yml`. (Commit and push)
By default, this token has only 'public_repo' scope.        

To ensure your token is active : 

```
export GITHUB_TOKEN="<YOUR_GENERATED_TOKEN>"; curl -is https://api.github.com/zen  -H "Authorization: token ${GITHUB_TOKEN}"| grep -E "^X-RateLimit"
```
As result, you should get `X-RateLimit-Limit` set to `5000`

3. Check [detailed content](#version-detailed-content) section below to apply related secrets steps in `Manual platform ops pre-merge steps` section, with `TODO pre-upgrade` tag.
This may also include stemcell upload steps.

Don't yet apply the post deployment steps marked with `TODO post-update` tag (`Manual platform ops post` sections), and rather run them once concourse `upgrade-to-paas-templates-*` pipeline has been applied.

4. In particular, make sure to apply the pre-upgrade step for `feature-shieldv8-micro-depls-migration`

When every secret are updated, you can trigger `paas-templates-46.0.0-upgrade/jobs/OPS-manually-check-and-fix-updated-secrets`

### Recreate micro-bosh (manual-step-recreate-micro-bosh)

1. Trigger `manual-step-recreate-micro-bosh` job, and when it turns green, and you have check that micro-bosh well recreated, trigger `OPS-manually-ensure-micro-bosh-recreation-is-successfull`

### Update credhub-ha (step-8-upgrade-micro-depls-credhub-ha)

Unpause the job `paas-templates-xxx-upgrade/jobs/step-8-upgrade-micro-depls-credhub-ha`. Note the job `micro-depls/pipelines/micro-depls-bosh-generated/jobs/deploy-credhub-ha` may transiently fail with `Expected to find variables: docker-registry-url`. This is a race condition for the credhub api within concourse

In this case, just retrigger manually the job.


### Update concourse (step-9-upgrade-micro-depls-concourse)

Unpause the job `paas-templates-xxx-upgrade/jobs/step-9-upgrade-micro-depls-concourse`, and check that it turn green.


### Check and fix micro deployments (OPS-manually-check-and-fix-micro-bosh-deployments)

The shield job registration is now performed by errand automatically scheduled by concourse (`run-errand-<deployment-name>-shield-provisioning`). Unfortunately, errors triggering during this errands are masked and the errand turn green. Please make sure to check individual errands manually for error message.


### Check and fix master deployments (OPS-manually-check-and-fix-master-bosh-deployments)

There is currently a dependency between isolation-segment-intranet-*, and cf deployments that the update pipeline does not yet orchestrate. Following declaration of new credhub secrets in the cf deployment (e.g. ` '/bosh-master/cf/prom_scraper_metrics_tls', the isolation-segment-intranet-* deployments may require manual triggering of the associated cf concourse jobs.

The shield job registration is now performed by errand automatically scheduled by concourse (`run-errand-<deployment-name>-shield-provisioning`). Unfortunately, errors triggering during this errands are masked and the errand turn green. Please make sure to check individual errands manually for error message.


### Check that all terraform have been applied on the platform
- micro-depls/pipelines/micro-depls-bosh-generated/jobs/approve-and-enforce-terraform-consistency
- ops-depls/pipelines/ops-depls-bosh-generated/jobs/approve-and-enforce-terraform-consistency
- master-depls/pipelines/master-depls-bosh-generated/jobs/approve-and-delete-disabled-deployments
- coab-depls/pipelines/coab-depls-bosh-generated/jobs/approve-and-enforce-terraform-consistency


### Clean up (step-13-cleanup)

Please manually launch the job `paas-templates-xxx-upgrade/jobs/step-13-cleanup`  to trigger automatically clean up of bosh deployments.

Please manually launch the job `paas-templates-xxx-upgrade/jobs/step-13-cf-clean-scripts`  to trigger automatically clean up of cf apps deployments.


### Upgrade pipelines cleanup
Once all upgrade process ended, destroy upgrade pipelines (`coa-v4.*-upgrade`, `upgrade-to-paas-templates-*` and `init-upgrade-pipelines`)
You can use `destroy-this-pipeline-at-the-end` or `execute-this-to-destroy-this-pipeline-once-upgrade-is-complete` jobs to do this


# Version detailed content:

## feature-fix-loggregator-log-verbosity
bump loggregator to avoid issue

### New features

#### Operators

### Compliance
* Iaas Type
  * [X] Openstack Iaas Type
  * [X] vSphere Iaas Type

### References
- https://github.com/orange-cloudfoundry/paas-templates/issues/785

### Content (implementation)
* [X] bump loggregator-version: "106.3.9"


## feature-fix-v46.0.0
This branch contains fixes on v46.0.0 after first installation on BRMC-INT

### Compliance
* Iaas Type
  * [x] Openstack Iaas Type
  * [x] vSphere Iaas Type

#### Pre-upgrade steps (once reference branch is merged, upgrade prerequisite. Config/secrets update)
- update shared/secrets.yml in order to add netmask key depending on your environment
- netmask value must be 255.255.255.0 for /24
- netmask value must be 255.255.255.192 for /26
- netmask value must be 255.255.255.224 for /27
``` yaml
  osb_data_plane_dedicated_public:
    net_id: vxw-dvs-27-virtualwire-78-sid-7029-VXS_CFY_MP_Int_S3_2
    range: 10.118.42.192/26
    netmask: 255.255.255.192 #255.255.255.0 for /24, 255.255.255.192 for /26, 255.255.255.224 for /27
    gateway: 10.118.42.193
    reserved_dhcp: 10.118.42.194 - 10.118.42.197
    static: 10.118.42.198 - 10.118.42.208
```

## feature-prometheus-vsphere-exporter

### New features
#### Operators
Operators on vsphere can benefit from vsphere level metrics.

### Compliance
* Iaas Type
  * [ ] Openstack Iaas Type
  * [X] vSphere Iaas Type

### References
- https://github.com/orange-cloudfoundry/paas-templates/issues/404
- https://hub.docker.com/r/pryorda/vmware_exporter


#### Limitations (known remaining issues)
- no default vsphere grafana dashboard provided

### Content (implementation)
* [x] add a docker engine + docker vm exporter image on micro-depls/bosh-master
* [x] add a scrape from master-depls/prometheus to bosh-master.internal.paas exporter endpoint

### Expected upgrade availability impacts during maintenance window
#### Operators
- Monitoring on prometheus lost: down 5 mn

## feature-use-cached-java-buildpacks-on-coab
Use cached-java-buildpacks for all brokers

### Compliance
* Iaas Type
  * [x] Openstack Iaas Type
  * [x] vSphere Iaas Type

## feature-fix-concourse-flavors
Add 100 Go ephemeral disk to `concourse` deployment to fix transient `no space left` error message.

### Compliance
* Iaas Type
  * [x] Openstack Iaas Type
  * [x] vSphere Iaas Type

### References
- https://github.com/orange-cloudfoundry/paas-templates/issues/448

### Content (implementation)
* [x] Add new operator to `concourse` deployment to set 100 Go ephemeral disk
* [x] Adjust `100GB_ephemeral_disk` vm extension to 100 Go (previously 150 Go)

### Manual platform ops

#### Post-upgrade steps (after upgrade pipeline is done)

- Check/purge concourse `stalled` workers (if exist)

``` bash
$ log-fly (select choice 1)
$ fly workers
$ fly prune-worker -a
```

### Expected upgrade availability impacts during maintenance window

#### Operators
- Concourse portal down: 16 mn

## feature-fix-coab-redis-sentinel-for-vsphere
this branch adapts the dedicated service redis sentinel plan for vsphere usage.

### Compliance
* Iaas Type
  * [x] Openstack Iaas Type
  * [x] vSphere Iaas Type

### References
- https://github.com/orange-cloudfoundry/paas-templates/issues/762

### Content (implementation)
* [x] Add new operators for vsphere in order to change networks
* [x] Update pre-deploy.sh COA hook in order to copy operators only for vsphere

## feature-profile-for-70-enable-bi-cdc-event-infra

Separate cdc, kafka and yugabyte cluster in 70-enable-bi-cdc-event-infra
New COA Profile 70-enable-bi-cdc-event-infra

### New features
#### Operators
Operators can choose to opt-in the cdc cf BI feeding.
Platform fooprint will be reduced if profile is not set (~ 10 vm, 1 To storage).


### Compliance
* Iaas Type
  * [X] Openstack Iaas Type
  * [X] vSphere Iaas Type
* Profiles
  * [X] Apply on Profile 70-enable-bi-cdc-event-infra

### References
- https://github.com/orange-cloudfoundry/paas-templates/issues/763

### Content (implementation)
* [x] define a new COA profile 70-enable-bi-cdc-event-infra
* [x] adapt master-depls/metabase for profile
* [x] adapt master-depls/cloudfoundry-datastore/postgres for profile (postgres CDC configuration)


## feature-update-flavors
Update deployments with new vm flavors and ephemeral disks.

### Compliance
* Iaas Type
  * [x] Openstack Iaas Type
  * [x] vSphere Iaas Type

### References
- https://github.com/orange-cloudfoundry/paas-templates/issues/448

### Content (implementation)
* [x] Update flavor on `micro-depls/concourse`
* [x] Update flavor on `micro-depls/credhub-ha`
* [x] Update flavor on `micro-depls/credhub-seeder`
* [x] Update flavor on `micro-depls/dns-recursor`
* [x] Update flavor on `micro-depls/docker-bosh-cli`
* [x] Update flavor on `micro-depls/internet-proxy`
* [x] Update flavor on `micro-depls/internet-relay`
* [x] Update flavor on `micro-depls/jcr`
* [x] Update flavor on `micro-depls/minio-private-s3`
* [x] Update flavor on `micro-depls/nexus`
* [x] Update flavor on `micro-depls/prometheus-exporter-master`
* [x] Update flavor on `master-depls/bosh-coab`
* [x] Update flavor on `master-depls/bosh-kubo`
* [x] Update flavor on `master-depls/bosh-ops`
* [x] Update flavor on `master-depls/bosh-remote-r2`
* [x] Update flavor on `master-depls/bosh-remote-r3`
* [x] Update flavor on `master-depls/cf`
* [x] Update flavor on `master-depls/cf-autoscaler`
* [x] Update flavor on `master-depls/cf-internet-rps`
* [x] Update flavor on `master-depls/cfr-ps`
* [x] Update flavor on `master-depls/cloudfoundry-datastores`
* [x] Update flavor on `master-depls/external-saas-relay`
* [x] Update flavor on `master-depls/intranet-interco-relay`
* [x] Update flavor on `master-depls/isolation-segment-internet`
* [x] Update flavor on `master-depls/isolation-segment-intranet-1`
* [x] Update flavor on `master-depls/isolation-segment-intranet-2`
* [x] Update flavor on `master-depls/logsearch`
* [x] Update flavor on `master-depls/logsearch-ops`
* [x] Update flavor on `master-depls/metabase`
* [x] Update flavor on `master-depls/openldap`
* [x] Update flavor on `master-depls/ops-routing`
* [x] Update flavor on `master-depls/osb-routing`
* [x] Update flavor on `master-depls/prometheus`
* [x] Update flavor on `master-depls/prometheus-exporter-coab`
* [x] Update flavor on `master-depls/prometheus-exporter-ops`
* [x] Update flavor on `master-depls/r1-vpn`
* [x] Update flavor on `master-depls/shieldv8`
* [x] Update flavor on `master-depls/vpn-interco`
* [x] Update flavor on `master-depls/weave-scope`
* [x] Update flavor on `ops-depls/cassandra`
* [x] Update flavor on `ops-depls/cf-rabbit37`
* [x] Update flavor on `ops-depls/cf-redis`
* [x] Update flavor on `ops-depls/cloudfoundry-mysql`
* [x] Update flavor on `ops-depls/io-bench`
* [x] Update flavor on `ops-depls/kafka`
* [x] Update flavor on `ops-depls/memcache`
* [x] Update flavor on `ops-depls/mongodb`
* [x] Update flavor on `ops-depls/neo4j-docker`
* [x] Update flavor on `ops-depls/nfs-volume`
* [x] Update flavor on `ops-depls/postgresql-docker`
* [x] Update flavor on `ops-depls/vault`
* [x] Update flavor on `kubo-depls/bui`
* [x] Update flavor on `remote-r2-depls/00-bootstrap`
* [x] Update flavor on `remote-r3-depls/00-bootstrap`

### Manual platform ops

|**Old flavors**|**New flavors**|
|-----|-----|
|default|1cpu-4g|
|large|2cpu-8g|
|xlarge|4cpu-16g|

#### Pre-upgrade steps (once reference branch is merged, upgrade prerequisite. Config/secrets update)
- Update following values in `master-depls/logsearch/secrets/meta.yml` and `master-depls/logsearch-ops/secrets/meta.yml` files in secrets repository

``` yaml
meta:
  logsearch:
    elasticsearch_data_instances_vm_type: 2cpu-8g
    elasticsearch_master_instances_vm_type: 2cpu-8g
    ingestor_instances_vm_type: 2cpu-8g
```

- Update following values in `ops-depls/guardian-uaa/secrets/secrets.yml` file in secrets repository (openstack only)

``` yaml
instance_groups:
- name: guardian_uaa_qa
  instances: 1
  vm_type: 1cpu-4g
```

- Update following values in `ops-depls/guardian-uaa-prod/secrets/secrets.yml` file in secrets repository (openstack only)

``` yaml
- name: guardian_uaa_prod
  instances: 1
  vm_type: 1cpu-4g
```

#### Post-upgrade steps (after upgrade pipeline is done)

- Check/purge concourse `stalled` workers (if exist)

``` bash
$ log-fly (select choice 1)
$ fly workers
$ fly prune-worker -a
```

### Expected upgrade availability impacts during maintenance window

#### Operators
- Concourse portal down: 16 mn

## feature-rename-vms-flavors

Rename old vms flavors initally sticked to openstack iaas.

|**Old flavors**|**New flavors**|**vm_extension ephemeral disk**|
|-----|-----|-----|
|micro|1cpu-1g||
|small|1cpu-2g||
|default|1cpu-4g||
|medium|1cpu-4g||
|large|2cpu-8g||
|large-mysql|2cpu-8g|100GB_ephemeral_disk|
|worker|4cpu-8g|100GB_ephemeral_disk|
|xlarge|4cpu-16g||
|xlarge-mysql|4cpu-16g|200GB_ephemeral_disk|
|xlarge-highcapmysql|4cpu-16g|800GB_ephemeral_disk|
|-|8cpu-16g|100GB_ephemeral_disk|
|xxlarge|8cpu-32g|100GB_ephemeral_disk|
|xxlarge-mysql|8cpu-32g|400GB_ephemeral_disk|
|xxxlarge-highpowermysql|16cpu-64g|200GB_ephemeral_disk|

### IAAS Compliance
* [x] Openstack
* [x] vSphere

### References
- https://github.com/orange-cloudfoundry/paas-templates/issues/448

### Content (implementation)
* [x] Add new vms flavors names in **_shared-operators/cloud-config/*/vm-types-cloud-operators.yml_** and **_shared-operators/cloud-config/00-generic-vm-types-cloud-operators.yml_** files
* [x] Add new vms extensions in **_shared-operators/cloud-config/*/vm-extensions-cloud-operators.yml_** files
* [x] Update vm flavor and add `100GB_ephemeral_disk` on `gitlab` deployment

## feature-fix-syslog-collection-regression

fix syslog agent target port 5514 on logsearch-ops

### Compliance
* Iaas Type
  * [X] Openstack Iaas Type
  * [X] vSphere Iaas Type

## feature-fix-route-interco
Add route for dedicated/pub on interco-relay in order to fix shield mongodb dedicated backup (nodes to be backuped are exposed on public network)

### References
- https://github.com/orange-cloudfoundry/paas-templates/issues/742

### Content (implementation)
- Add route for dedicated/pub on interco-relay

### IAAS Compliance
* [ ] Openstack
* [x] vSphere

## feature-osb-cmdb-15-clients

Increase number of osb-cmdb broker instances from 6 to 16, with index from 0 to 15.

### Content (implementation)
- Script now handles 16 copies of osb-cmdb
- Ran script to initialize 6-15 instances

#### Limitations (know remaining issue)
- Does not initiate secrets for osb-cmdb 6 to 15.

### Manual platform ops post-install steps
- Enable osb-cmdb instance as required. Remember to adapt the index number when copy/pasting an existing secrets config

### Expected availability impacts
- cf apps management: 2 mins (triggers osb-cmdb pipeline for all instances)

## feature-credhub-seeder-shared-secrets-trigger-activation

Re-enable automatic triggering for credhub-seeder on shared/secrets.yml changes.

### Content (implementation)
- Activate local-deployment-scan in `deployment-dependencies.yml`
- Automatically create missing `secrets.yml` during upgrade

### IAAS Compliance
* [X] Openstack
* [X] vSphere

## feature-osb-cmdb-config-fix

Fix osb-cmdb config regression introduced in !694 (feature-osb-cmdb-auth-fix): operator settings in meta.yml were ignored. In particular, dynamic catalog tunings are ignored.

Properties from meta.yml need to be set in application-cloud.yml to be loaded and not application-default.
The default profile is not loaded by spring since java buildpack assigns the cloud profile

### Content (implementation)
- Fix pre-deploy logic.

## feature-cfcr-fix-v46 
- bump traefik 2.2
- remastering deployment cfcr-addon => k8s-addon
- extract from k8s-addon to create independent deployment:
  - k8s-jaeger
  - k8s-traefik
  - k8s-logging
  - k8s-prometheus
- change docker mirror from nexus to jcr
- switch to docker to containerd (eject docker from cfcr)
- add dependency for releases:helm-kubectl:

### References
- https://github.com/orange-cloudfoundry/helm-kubectl-boshrelease/releases/tag/v20
- https://github.com/orange-cloudfoundry/kubo-release/releases/tag/0.42.1

### Content (implementation)
- raise cfcr serv ulimit 

#### Limitations (know remaining issue)
- https://github.com/orange-cloudfoundry/paas-templates/issues/719

### IAAS Compliance
* [X] Openstack
* [X] vSphere

##  feature-bumps-for-v46-5
Bump cfcr bosh releases.

### IAAS Compliance
* [X] Openstack
* [X] vSphere

### References
- https://github.com/orange-cloudfoundry/kubo-release/releases/tag/0.41.1
- https://github.com/orange-cloudfoundry/containerd-boshrelease/releases/tag/1

### Content (implementation)
- bump cfcr to orange release 0.41.1
- bump containerd release 1
- bump helm kubectl release 20

## feature-jcr-update
- add rook-release helm chartrepository
- add suse helm chart repository
- add local repository for osb-cmdb-build
- add repoLayout: simple default to fix the docker repository trouble
- enableTokenAuthentication on docker repository

### References
- https://stackoverflow.com/questions/60993665/how-to-set-repolayoutref-by-code-for-remote-docker/61001458#61001458
- https://stackoverflow.com/questions/60975820/missing-manifest-from-docker/60976009?noredirect=1#comment107910940_60976009
- https://stackoverflow.com/questions/60675538/jcr-cant-add-some-helm-repository/60676095#60676095

### IAAS Compliance
* [X] Openstack
* [X] vSphere

### Manual platform ops post-merge steps
- trigger jcr errand

## feature-fix-shield-dedicated-proxy-on-vsphere
this branch fixes proxy usage on vsphere dedicated deployments.

### Content (implementation)
* [x] Fix mongodb
* [x] Fix cf-mysql
* [x] Fix cf-rabbit

### IAAS Compliance
* [ ] Openstack
* [x] vSphere

## feature-fix-shield-storage-on-coab-depls
this branch aims to fix storage support on dedicated services backup

### References
- https://github.com/orange-cloudfoundry/paas-templates/issues/736

### Content (implementation)
- Add script in order to backup and restore shield inventory
- Update model deployment to have a persistent disk instead of a transient one

### IAAS Compliance
* [x] Openstack
* [x] vSphere

### Expected availability impacts
no impact

### Manual platform ops pre-merge steps
remove hotfix branch - feature-fix-shield-storage-on-coab-depls

## feature-certs-rotation
Optimization/completion for certs rotation process.

### IAAS Compliance
* [x] Openstack
* [x] vSphere

### References
- https://github.com/orange-cloudfoundry/paas-templates/issues/102

### Content (implementation)
* [x] Update `minimum_down_jobs` to 8 on `micro-bosh` and `bosh-master` directors for resurrector used on `credhub-ha` and `ops-routing` deployments
* [x] Add `jcr` job to concourse excluded jobs to unpause in `admin/unpause.sh` script
* [x] Add commit step to certs rotation admin scripts
* [x] Add `admin/restart-concourse-workers.sh` script
* [x] Update `zz-docs/Certs_rotation.md`documentation

## feature-optimize-gitlab
Fix http 502 errors when huge parallel bosh deployments.

### IAAS Compliance
* [x] Openstack
* [x] vSphere

### References
- https://github.com/orange-cloudfoundry/paas-templates/issues/731

### Content (implementation)
* [x] Update flavor instance type to `xxlarge` (8 cpus)
* [x] Update gitlab unicorn workers numbers to `13` according gitlab requirements

## feature-hotfix-logsearch-ops

Improving Logsearch-ops deployment

### References
- https://github.com/orange-cloudfoundry/paas-templates/issues/576

### Content (implementation)
- Adapting Logsearch-Ops to vSphere
- Adding static IP to es-master
- Correction on DNS entry to target es-master
- Removing logsearch (not the ops one) from Prometheus deployment
- Changing elasticsearch_data disk size (passing to xlarge : 110Go)
- Correction post rebase v43
- Curator add to purge log older than 7 day

#### Limitations (know remaining issue)
- Some services instances do not send their log 

### IAAS Compliance
* [X] Openstack
* [X] vSphere

### End user new features
Log of PaaSTemplate stack component is accessible through Kibana

### Manual platform ops pre-merge steps
Take care to have sufficent disk space on elasticsearch_data nodes or deployment will hang on drain script during shutdown
Check persistent disk size :
``` bash
log-bosh
(2)
(logsearch-ops)
bosh vms --vitals --column=instance --column=persistent_disk_usage
(elasticsearch_data nodes should be under 80%)
```

If data nodes are full, clear the old indices
``` bash
curl http://192.168.99.112:9200/_cat/indices?s=index
curl -X DELETE http://192.168.99.112:9200/logs-platform-2020.<XX>.<YY>
```
Change <XX> and <YY> by the corresponding indices and repeat it until data nodes have more than 20% disk free space

### Expected availability impacts
## feature-bump-jcr
refactor the JCR installation and bump jcr 7.3.2 and add automatic provisioning

### References
- https://www.jfrog.com/confluence/display/JFROG/JFrog+Container+Registry
- https://www.jfrog.com/confluence/display/JFROG/Artifactory+YAML+Configuration

### Content (implementation)
- add a nex deployment of JCR
- remove JCR from nexus deployment

#### Limitations (know remaining issue)
- https://github.com/orange-cloudfoundry/paas-templates/issues/725

### IAAS Compliance
* [x] Openstack
* [x] vSphere

### Manual platform ops post-install steps
- get password on credhub that will be use by next step:
` credhub get -n /micro-bosh/jcr/jcr_admin_password`
- as mention into https://github.com/orange-cloudfoundry/paas-templates/issues/725
the first deployment requieres that concourse job is launch **twice** before see the admin ui
at this url: https://jcr.((/secrets/cloudfoundry_ops_domain))/
To log in the default user password is: admin/password
- set the new password with the password you got from credhub
- sign the eula

- you can skip other param as the errand will set them automaticaly (if you have set the credhub password)
- launch the manual errand to finalize the configuration



## feature-coab-v46-bis
Updates to coab common broker scripts for use in !694 : assert that unauthenticated OSB `v2/catalog` calls are rejected

## feature-bumps-for-v46-4
bump kubectl helmsh-releases

### IAAS Compliance
* [x] Openstack
* [x] vSphere

### References
- https://github.com/orange-cloudfoundry/paas-templates/issues/000

### Content (implementation)
* [x] Update `kubectl helm` release to `19`
* [x] Update `bpm` release to `1.1.5` and sha1 in `micro-depls`
* [x] Update `cfcr-etcd` release to `1.12.0` in `micro-depls`, `master-depls` and `kubo-depls`
* [x] Update `bosh-vsphere-cpi` release to `52.1.0` in `micro-depls`
* [x] Update `cf-mysql` release to `36.19.0` in `master-depls/cloudfoundry-datastores`
* [x] Fix duplicate lines in `master-depls/template/deploy.sh`

## feature-coa-profiles-for-bosh-debug

This features adds bosh director operators, enabled by COA profiles, creating bosh deployment in debug mode:
- the vms are kept in case of failure for troubleshooting
- vcap password is no more random generated, but set to a well known value for troubleshooting.

NB: once troubleshooting is done, it is recommanded to disable debug profile and retrigger all bosh deployments to ensure secure random password.

### References
- https://github.com/orange-cloudfoundry/paas-templates/issues/706


### Content (implementation)
- define 99-debug-xx-depls profiles

#### Limitations (know remaining issue)
- https://github.com/orange-cloudfoundry/paas-templates/issues/003

### IAAS Compliance
* [X] Openstack
* [X] vSphere

### Profiles added
- 99-debug-master-depls
- 99-debug-ops-depls
- 99-debug-coab-depls
- 99-debug-kubo-depls
- 99-debug-remote-r2-depls
- 99-debug-remote-r3-depls

##  feature-openstack-secgroups-for-external-osb-consumers

set osb-sg on public shared osb network

### References
- https://github.com/orange-cloudfoundry/paas-templates/issues/705

### IAAS Compliance
* [X] Openstack
* [ ] vSphere

##  feature-interactive-ops-scripts

contains scripts useful during production incidents to diagnose or repair while usual automation is not possible.


### Content (implementation)
- restart-all-apps-in-one-org.bash

### IAAS Compliance
* [x] Openstack
* [x] vSphere

## feature-save-credhub-certs
Save credhub and uaa-credhub certs in `credhub` to follow expiration dates and generate alerts with prometheus

### IAAS Compliance
* [x] Openstack
* [x] vSphere

### References
- https://github.com/orange-cloudfoundry/paas-templates/issues/734

### Content (implementation)
* [x] Add credhub certs to `credhub-seeder` deployment

## feature-admin-2-v46
`admin` scripts fix/optimization.

### IAAS Compliance
* [x] Openstack
* [x] vSphere

### Content (implementation)
* [x] Fix `recreate-micro-bosh.sh` script when used in concourse upgrade pipeline 
* [x] Set default proxy for `recreate-micro-bosh.sh` script when used in manual step
* [x] Create links from `download` and `installations` directories in user `~/.bosh` to avoid using `config` file from other user
* [x] Give ops information to triger concourse `credhub-seeder` job after regenerating credhub certs

## feature-osb-cmdb-auth-fix

Fixes lack of authentication on OSB API. Add observability endpoints (springboot 2.1.8 actuator endpoints) protected by an admin account (user=admin and password stored in credhub)

### References
- https://github.com/orange-cloudfoundry/paas-templates/issues/000 (redacted pending issue disclosure)

### Content (implementation)
- Now paas-templates provides yaml-formatted configuration to osb-cmdb in `application-default.yml` which possibly overrides default properties defined within the jar at `application.yml`
- Add observability endpoints (springboot 2.1.8 actuator endpoints) protected by an admin account (user=admin and password stored whose password is stored in credhub at path `/${root_deployment}/cf-apps-deployments/${deployment}/broker-admin-password`)

## feature-fix-coab-buckets
this branch aims to fix coab buckets creation

### Content (implementation)
* [x] Fix for cassandra
* [x] Fix for cf-msql
* [x] Fix for cf-rabbit
* [x] Fix for mongodb

### IAAS Compliance
* [x] Openstack
* [x] vSphere

## feature-change-shield-exposition-on-dedicated-services
this branch aims to change shield server exposition on dedicated services

### References
- https://github.com/orange-cloudfoundry/paas-templates/issues/711

### Content (implementation)
* [x]  Change communication for cassandra
* [x]  Change communication for cf-msql
* [x]  Change communication for cf-rabbit
* [x]  Change communication for mongodb

### IAAS Compliance
* [x] Openstack
* [x] vSphere

## feature-add-parameters-to-cf-rabbit-shared
this feature adds optional parameters to the shared rabbitmq service which can be configured in secrets repository
- number of nodes
- partition strategy

## feature-fix-cf-rabbit-dedicated-backup
this branch fixes cf-rabbit dedicated backups

## feature-hotfix-missing-route

We can observe that some route fail silently to be implemented on VM with 2 NIC.
As we can not be sure on which interface a network would be mounted and as this information (interface) is redundant with gateway, we can omit it

### References
- https://github.com/orange-cloudfoundry/paas-templates/issues/704

### Content (implementation)
- Removing interface specification from 
* Isolation segment Intranet 
* Intranet inter relay 
* OSB relay 
* API relay 
* DNS recursor 
* Internet relay 

It only concern vSphere operators

### IAAS Compliance
* [ ] Openstack
* [X] vSphere

### Expected availability impacts
- cf api: down 5 to 10 min
- cf apps exposition: down 5 to 10 min
- service manipulation : down 5 to 10 min
- intranet interco: down 5 to 10 min
- internet interco: down 5 to 10 min

## feature-feature-coa-upgrade-to-4-3-2
Bump of [cf-ops-automation](https://github.com/orange-opensource/cf-ops-automation) to latest [4.3.x](https://github.com/orange-cloudfoundry/cf-ops-automation/releases/tag/v4.3.2) version is required.

### References
- [4.3.2 release notes](https://github.com/orange-cloudfoundry/cf-ops-automation/releases/tag/v4.3.2)
- [4.3.2 issues](https://github.com/orange-cloudfoundry/cf-ops-automation/milestone/15?closed=1)
- [4.3.1 release notes](https://github.com/orange-cloudfoundry/cf-ops-automation/releases/tag/v4.3.1)
- [4.3.1 issues](https://github.com/orange-cloudfoundry/cf-ops-automation/milestone/14?closed=1)
- [4.3.0 release notes](https://github.com/orange-cloudfoundry/cf-ops-automation/releases/tag/v4.3.0)
- [4.3.0 issues](https://github.com/orange-cloudfoundry/cf-ops-automation/milestone/12?closed=1)

### IAAS Compliance
* [x] Openstack
* [x] vSphere


## feature-fix-credhub-seeder
Manage values with spaces for credhub `value:` type (needed for ips range).

### IAAS Compliance
* [x] Openstack
* [x] vSphere

### Content (implementation)
* [x] Update credhub cli to 1.7.0
* [x] Allow spaces for `value:` type values in scripting release

## feature-admin-v46
Fix/optimize admin tools scripts

### IAAS Compliance
* [x] Openstack
* [x] vSphere

### Content (implementation)
* [x] Add `show-credhub-certs.sh`, `recreate-bosh-deployments.sh` and `clean-credhub-properties.sh` scripts
* [x] Fix `recreate-micro-bosh.sh` script for dns
* [x] Add `remote-r2` and `remote-r3` bosh directors to tools
* [x] Rename scripts for best understanding
* [x] Update bosh-dns certs from `shared/certs/bosh-dns` files in secrets repository within bootstrap process (share bosh-dns api certs between all deployments)
* [x] Detail cert rotation process documentation

## feature-bumps-v46-3

- additional bumps for v46
- explicit version instead of latest for non bosh.io releases
- let COA bosh release naming match native bosh release naming (enables future bosh releases precompilation use cases)

### References
- https://github.com/orange-cloudfoundry/paas-templates/issues/653

### Content (implementation)
- bump bosh dns 1.17.0 on ops-depls
- bump wireguard bosh release https://github.com/orange-cloudfoundry/wireguard-boshrelease/releases/tag/v2

### IAAS Compliance
* [X] Openstack
* [X] vSphere

## feature-ocb-cmdb-v46

* Bump osb-cmdb to 0.7.0 to support K8S client. Was tested with OpenShift v3.9.51 ( Kubernetes v1.9.1+a0ce1bc657 ), with sync service (p-mysql) and async (no-op) with CUD operations.
* Bump osb-cmdb to 0.8.0 to support service instance and service binding params. Tested with osb-cmdb component automated tests and manually in paas-templates using overview broker on fe-int


### References
- https://github.com/orange-cloudfoundry/osb-cmdb-spike/releases/tag/v0.7.0
- https://github.com/orange-cloudfoundry/osb-cmdb-spike/releases/tag/v0.8.0

### Content (implementation)
- Bump osb-cmdb to 0.8.0
- Refine overview broker doc
- Refine cmdb symlink scripts


### Manual test procedure
1.  enable overview broker (in secrets in `ops-depls/cf-apps-deployments/overview-broker/`)
1. manually register overview broker to be visible in osb-cmdb-0 using CF CLI, see procedure in `ops-depls/cf-apps-deployments/overview-broker/README.md`
1. create service instance and service binding using CF CLI
```
cf cs overview-service small overview-gberche-4 -b osb-cmdb-broker-0 -c '{"engine":"innodb"}'
#Loop until service provisions, approx 2 mins
cf s
cf create-service-key overview-gberche-4 overview-key4 -c '{"permissions":"read-only"}'
```
4. manually check in overview broker dashboard https://redacted_username:redacted_password@overview-broker.api_domain/dashboard that the params appear in the recent provisionning request (`PUT` requests) # credential_leak_validated


## feature-hotfix-concourse-db-dns-alias

Concourse DB instance is now self-providing an DNS alias to the bosh-dns.
Changing concourse-db scrape operators from fetching a static IP to the new DNS Alias 

### References
- https://github.com/orange-cloudfoundry/paas-templates/issues/720

### Content (implementation)
- Added custom provided link on concourse db instance
- Added a DNS alias on concourse db instance
- Changed concourse-db scrape operator (from Prometheus-exporter-master) to scrape a DNS alias

### IAAS Compliance
* [x] Openstack
* [x] vSphere

## feature-fix-syslog-forwarder-514
Fix syslog forwarder configuration to avoid CLOSE_WAIT saturation

### References
- https://github.com/orange-cloudfoundry/paas-templates/issues/514

### Content (implementation)
- syslog forwarder : use tcp protocol. filter debug messages

### IAAS Compliance
* [X] Openstack
* [X] vSphere

## feature-coab-v46
coab fixes and enhancements for v46

### References
- https://github.com/orange-cloudfoundry/paas-templates/issues/681
- https://github.com/orange-cloudfoundry/paas-templates/issues/655
- https://github.com/orange-cloudfoundry/paas-templates/issues/683
- https://github.com/orange-cloudfoundry/paas-templates/issues/653

### Content (implementation)
* [x] common broker script hardening for invalid/missing value for `coab-depls/cf-apps-deployments/coa-*broker/secrets/secrets.yml` `secrets.mode`key (issue 681)
   * [x] Bumped common-broker symlinks in coab by executing `./coab-depls/common-broker-scripts/commit-and-bump-shared-content.sh`. See background in [issue 681: COAB brokers don't use latest version of common broker scripts in v44 and some fail: #681 ](https://github.com/orange-cloudfoundry/paas-templates/issues/681)
* [x] COAB instances retrofit (issue 655)
* [x] prevent from unexpected no-op bosh updates triggering (issue 683)
* [x] harden not bosh.io releases (issue 653)
* [x] buckets creation change (today hold in init-shield.sh) for cf-rabbit 

### IAAS Compliance
* [x] Openstack
* [x] vSphere

## feature-fix-latest-on-ops-depls
this branch removes latest versions on ops-depls

### References
- https://github.com/orange-cloudfoundry/paas-templates/issues/653

### Content (implementation)
* [x]  cassandra
* [x]  cf-rabbit37
* [x]  guardian-uaa*
* [x]  mongodb
* [x]  neo4j-docker
* [x]  postgresql-docker
* [x]  vault
* [x]  generic scripting version for all deployments (shield root cause)

### IAAS Compliance
* [x] Openstack
* [x] vSphere

## feature-change-schedule-of-mariadb-backups
this branch fixes shared mariadb backups schedule  

### References
- https://github.com/orange-cloudfoundry/paas-templates/issues/724

### Content (implementation)
- Add a share operator which patches the provisioning errand (change backup time on node with index 1 and node with index 2)
- Use the share operator in ops-depls/cloudfoundry-mysql deployment
- Use the share operator in ops-depls/cloudfoundry-mysql-osb deployment 
- Clean useless shieldv8 configuration in deployments (credhub-ha, concourse, bosh-master and cloudfoundry-datastore)  

### IAAS Compliance
* [x] Openstack
* [x] vSphere

### Manual platform ops post-merge steps
- execute manual errand in order to clean useless configuration (https://<CONCOURSE_URL>/teams/master-depls/pipelines/master-depls-bosh-generated/jobs/run-manual-errand-shieldv8-errand-scripting)

## feature-dashboard-redis-grafana
* Add dashboard grafana and alert prometheus for Redis dedicated
* Add dashboard mysql with deployement variable (https://github.com/bosh-prometheus/prometheus-boshrelease/pull/271)
* Add dashboard rabbitmqwith deployement variable 

### References
- https://github.com/orange-cloudfoundry/paas-templates/issues/668
- https://github.com/orange-cloudfoundry/prometheus-addons-boshrelease

### IAAS Compliance
* [x] Openstack
* [x] vSphere

## feature-redis-5.0.7
* Upgrade Redis to 5.0.7
* add exporter sentinel for grafana dashboard
* add maxmemory to 3Go

### References
 - https://github.com/orange-cloudfoundry/paas-templates/issues/669

### IAAS Compliance
* [x] Openstack
* [x] vSphere

## feature-update-plan-mysql

Update plan dedicated cf-mysql :
* SMALL : Increase `max-connection` to 70 instead of 50
* LARGE : Decrease `max-connection` to 200 instead of 250 and use vm_type `xlarge` (4CPU/16Go)

Add new plan medium-big-request with 
* `max_heap_table_size` and `tmp_table_size` to 256Mo
* `max_connextion` at 15

Update all plan dedicated (except medium-big-request) change value of mysql system variable : 
* `max_heap_table_size` to 32Mo instead of 16Mo

### References
- https://github.com/orange-cloudfoundry/paas-templates/issues/698

#### Limitations (know remaining issue)
- https://github.com/orange-cloudfoundry/paas-templates/issues/698

### IAAS Compliance
* [x] Openstack
* [x] vSphere

### Manual platform ops steps
- add price in int-secrets/coab-depls/cf-apps-deployments/coa-cf-mysql-broker/secrets/secrets.yml
```sh
secrets:
  coa-cf-mysql-broker:
...
    plan-coab-mariadb-price:
    # price
   
      medium-big-request: <value>
   
```
- update broker-coab-cf-mysql with new plan

## feature-fix-micro-bosh-dns
Add `bosh-dns` job to `micro-bosh` (fix mismatch dns configuration with new stemcells)

### IAAS Compliance
* [x] Openstack
* [x] vSphere

### References
- https://github.com/orange-cloudfoundry/paas-templates/issues/xxx

### Content (implementation)
* [x] Set `dns-operators.yml` common to each iaas for micro-bosh creation
* [x] Delete `aliases` for openstack iaas
* [x] Use `micro-depls-versions.yml` content for `bosh-dns` release version/sha1

## feature-ops-portal-v46
Add new portals for v46 release

### IAAS Compliance
* [x] Openstack
* [x] vSphere

### Content (implementation)
* [x] Add `JFrog` new portal
* [x] Add `K8DASH` new portals


## feature-profile-for-weave-scope

Leverage COA 4.3 support for profile
Weave-scope agent provisionning on vm is only for new profile 90-weave-scope

### Content (implementation)
- move master-depls weave-scope-scope to dedicated prof

### IAAS Compliance
* [X] Openstack
* [X] vSphere


## feature-bumps-for-v46
this branch aims to gather bumps for v46 release (stemcell, bosh-releases, ...)

### References
- https://github.com/cloudfoundry/bosh-dns-release/releases/tag/v1.17.0
- https://github.com/orange-cloudfoundry/helm-kubectl-boshrelease/releases/tag/18.0
- https://github.com/bosh-prometheus/prometheus-boshrelease/releases
- https://github.com/cloudfoundry/bosh-linux-stemcell-builder/releases/tag/ubuntu-xenial%2Fv621.55
- https://github.com/cloudfoundry/cflinuxfs3/releases/tag/0.164.0
- https://github.com/cloudfoundry-community/cron-boshrelease/releases/tag/v1.3.0
- https://github.com/cloudfoundry/cf-deployment/releases/tag/v12.28.0
- https://github.com/cloudfoundry/bosh/releases/tag/v270.11.0
- https://github.com/cloudfoundry/cf-deployment/releases/tag/v12.27.0
  - https://github.com/cloudfoundry/routing-release/releases/tag/0.197.0
  - https://github.com/cloudfoundry/cf-deployment/releases/tag/v12.25.0
  - https://github.com/cloudfoundry/diego-release/releases/tag/v2.42.0
  - https://github.com/cloudfoundry/uaa-release/releases/tag/v74.13.0

https://github.com/cloudfoundry/cf-deployment/releases/tag/v12.12.0

### Content (implementation)
- bump helm-ctl bosh release
- bump prometheus bosh release
- add open vpn bosh release in /submodules
- bump ruby buildpacks to 1.8.10
- bump stemcell
- bump cflinuxfs3
- delete obsolete dns creation operator for bosh-master
- bump cf-deployment 12.28.0
- bump bosh 270.11.0
- bump bosh-dns 1.17
- standardize COA release naming to match bosh release naming (enables precompilation uses cases)

#### Limitations (know remaining issue)
- https://github.com/orange-cloudfoundry/paas-templates/issues/003

### IAAS Compliance
* [x] Openstack
* [x] vSphere

### End user new features

updated buildpack set :
- go-buildpack-version: "1.9.7"
- java-buildpack-version: "4.26"
- dotnet-core-buildpack-version: "2.3.6"
- binary-buildpack-version: "1.0.36"
- nodejs-buildpack-version: "1.7.13"
- php-buildpack-version: "4.4.8"
- python-buildpack-version: "1.7.8"
- ruby-buildpack-version: "1.8.10"
- staticfile-buildpack-version: "1.5.4"
- nginx-buildpack-version: "1.1.5"
- r-buildpack-version: "1.1.1"

##  feature-cfcr-add-node-label
- add a new job on each worker of cfcr to add a predictable label
- bump concourse 5.8
- bump core dns to 1.6.6
- bump metrics-server
- bump openebs to 1.6
- ~~create several pv by the helm~~
- create a new storageclass dedicated to this new PV
- add label WORKER on each label node
- merge cfcr with cfcr-persistent-worker
- add bbr
- add traefik V2 on K8S-serv
- use containerd instead of docker
- add service catalog version 0.3.0-beta.2 on k8s serv
- add common var file on share-operator to evict var replication on each K8S 

### References
- https://github.com/orange-cloudfoundry/helm-kubectl-boshrelease/releases/tag/16.0
- https://github.com/containous/traefik/issues/6349
- https://github.com/containerd/containerd/issues/4012


### manual step
- add new remote helm repo inside JCR 
    - name: concourse 
      url: https://concourse-charts.storage.googleapis.com/
    - name: svc-cat
      url: https://svc-catalog-charts.storage.googleapis.com
    - name: jaegertracing
      url: https://jaegertracing.github.io/helm-charts
- add these repo in the virtual repo helm inside JCR


### IAAS Compliance
* [x] Openstack
* [x] vSphere


## feature-bbr-on-shieldv8
this branch aims to use bbr for compliant deployments  

### References
- https://docs.cloudfoundry.org/bbr/index.html
- https://github.com/orange-cloudfoundry/paas-templates/issues/678
- https://github.com/orange-cloudfoundry/paas-templates/issues/606
- https://github.com/orange-cloudfoundry/paas-templates/issues/607
- https://github.com/orange-cloudfoundry/paas-templates/issues/465

### Content (implementation)
* [x] Add bbr operator on bosh-master and provision configuration in shield v8 (in bosh-master deployment)
* [x] Add bbr operator on bosh-coab and provision configuration in shield v8 (in bosh-coab deployment)
* [x] Add bbr operator on bosh-ops and provision configuration in shield v8 (in bosh-ops deployment)
* [x] Add bbr operator on credhub-ha and provision configuration in shield v8 (in credhub-ha deployment)
* [x] Add bbr operator on concourse and provision configuration in shield v8 (in concourse deployment)
* [x] Add bbr operator on cfcr and provision configuration in shield v8 (in cfcr deployment)

### IAAS Compliance
* [x] Openstack
* [x] vSphere

### Manual platform ops post-merge steps
- execute manual errand in order to clean useless configuration (https://<CONCOURSE_URL>/teams/master-depls/pipelines/master-depls-bosh-generated/jobs/run-manual-errand-shieldv8-errand-scripting)

## feature-bbr-on-cloudfoundry
this branch aims to add bbr operators to cloudfoundry bosh deployment

## feature-bbr-on-micro-bosh
this branch aims to add bbr operators to micro-bosh director

### References
- https://github.com/orange-cloudfoundry/paas-templates/issues/510
- https://github.com/orange-cloudfoundry/paas-templates/issues/702
- https://github.com/orange-cloudfoundry/paas-templates/issues/688

### Content (implementation)
* [x] Use bbr operator from bosh-deployment on micro-bosh
* [x] Add vcap ssh public key to allow ssh access on vsphere
* [x] Update bootstrap script in order to create micro-bosh
* [x] Update admin script in order to recreate micro-bosh
* [x] Set micro-bosh persistent disk size to 150GB

### IAAS Compliance
* [x] Openstack
* [x] vSphere

## feature-clean-shieldv7
this branch removes shield v7 server and agents operator and clean secrets legacy entries

### References
- https://github.com/orange-cloudfoundry/paas-templates/issues/534

### Content (implementation)
* [x] Clean micro-depls
* [x] Clean master-depls
* [x] Clean ops-depls
* [x] Clean shield server
* [x] Clean ops portal (done in an another MR)
* [x] Clean credhub-seeder
* [x] Clean legacy shield variable (shield_legacy_version)
* [x] Upgrade script shield deployment destroy 
* [x] Upgrade script cleaning secrets file
* [x] Upgrade script cleaning credhub

### IAAS Compliance
* [x] Openstack
* [x] vSphere

## feature-fix-cfrabbit37-shared 

### References
- https://github.com/orange-cloudfoundry/paas-templates/issues/694

### Content (implementation)
* [x] Update cf-rabbit37 deployment with a manual errand in order to clean bad policy operator on all vhosts
* [x] Update cf-rabbit37 deployment cron job in order to add good policy operator on all vhosts
* [x] Add an upgrade script in order to change policy definition in meta.yml file

### IAAS Compliance
* [x] Openstack
* [x] vSphere

### Manual platform ops post-merge steps
- execute manual errand in order to clean useless policies (https://<CONCOURSE_URL>/teams/ops-depls/pipelines/ops-depls-bosh-generated/jobs/run-manual-errand-cf-rabbit37-errand-scripting)

## feature-switch-to-jcr-docker-registry
Create `jcr` deployment (support helm packages) to replace `nexus` and set docker-bosh-release to `/var/vcap/data` to reduce file overlays contentions on default directory installation `/var/vcap/store`

### IAAS Compliance
* [X] Openstack
* [X] vSphere

### References
- https://github.com/orange-cloudfoundry/paas-templates/issues/624
- https://github.com/orange-cloudfoundry/paas-templates/issues/640

### Content (implementation)
* [x] Modify master-depls/prometheus thanos store to use jcr 
* [x] Set `store_dir` to `var/vcap/data` for deployments using docker-bosh-release
  - micro-depls: `nexus`, `gitlab`, `openldap`
  - master-depls: `intranet-interco-relay`, `isolation-segment-internet`, `isolation-segment-intranet-2`, `metabase`, `prometheus`
  - ops-depls: `neo4j-docker`, `postgresql-docker`

### Manual platform ops post-install steps
- Switch concourse to jcr registry. In secrets repo `coa/config/credentials-docker-registry.yml`:

```
docker-registry-url: "docker.jcr.<ops_domain>/" #or "" to not use private registry
```


# V 48.0.0

- COA 5 / concourse 6
- bosh releases precompilation
- cf-deployment 13
- cf isolation segment for internal org
- stemcell update
- switch from cfcr to s&w k8s bosh release
- ops portal update
- mariadb 10.3 on dedicated services
- mongodb 4.2.9 / v12 on shared services
- cf-rabbit 3.8 on dedicated services
- stratos 3
- osbcmdb 1.1.0
- coab 0.31

# Installation overview

Please refer to [Upgrade_process](../../upgrade/Upgrade_process.md)

# Version detailed content:

## feature-fixes-for-48-0-1
Fix 48.0.0 release.

### Compliance
* Iaas Type
  * [x] Openstack Iaas Type
  * [x] vSphere Iaas Type

### Content (implementation)
* [x] Set `bosh-cli` to 2.1.43
* [x] Add pre-upgrad `03-set-credhub-certs.sh` script to set credhub certs in credhub for cert expiration alerting
* [X] Automate COA 5 precompile operations
   * [X] secrets creation
   * [X] desactivate precompile during COA 5 secrets update
   * [X] activate precompile during paas-template v 48 secrets update

## feature-fix-cf-networking-sample-apps
Fix cf networking sample app.

### Content (implementation)
- [x] Create 2 template files for cf deployment

## feature-concourse-tuning-v-48.0.1

revert to 12 workers with old vm_type, reduce garden max containers but keep extended network

### Compliance
* Iaas Type
  * [X] Openstack Iaas Type
  * [X] vSphere Iaas Type

### Content (implementation)
We restore workers number as we have issues with IO when we increase CPU numbers

## feature-fix-tasks-cleanup
Fix tasks cleanup errors `find: ‘./xxx’: No such file or directory` in `/var/vcap/sys/log/director/task_logrotate.log` log file.

### Compliance
* Iaas Type
  * [x] Openstack Iaas Type
  * [x] vSphere Iaas Type

### Content (implementation)
* [x] Add `-mindepth 1` find option to post-deploy operator and `recreate-micro-bosh.sh` script

## feature-remove-leaks-in-service-instances-git-branches
this branch includes a bash script in order to clean coab service instance leaks in GIT branches : 
- feature-coabdepls-cf-mysql-serviceinstances
- feature-coabdepls-cf-rabbit-serviceinstances
- feature-coabdepls-mongodb-serviceinstances
- feature-coabdepls-redis-serviceinstances
  
### Compliance
* Iaas Type
  * [x] Openstack Iaas Type
  * [x] vSphere Iaas Type

### References
- closes https://github.com/orange-cloudfoundry/paas-templates/issues/654

### Content (implementation)
* [x] Add a bash script in coab-depls/ops-scripts

### Manual platform ops

#### Pre-upgrade steps (once reference branch is merged, upgrade prerequisite. Config/secrets update)
- /!\ Provisioning of dedicated services (COAB) must be paused because the script updates service instance branches
- On BOSH-CLI, clone paas-templates repository
- Go to coab-depls/ops-scripts directory
- Launch the script clean_service_instance_leaks.sh (by default the script works with BRMC-INT repositories)
```bash
./clean_service_instance_leaks.sh
```
- You can pass other repositories url (PPROD and PROD) by using options on command line
```bash
./clean_service_instance_leaks.sh -p <Paas templates GIT PROD url> -s <Secrets GIT PROD url>
```
- You must review the four created branches with cleaned- prefix. Typically, ensure all the "live" services instances in concourse coab-depls are kept in the branch.
If they look consistent, you must replace manually regular instance branches with them. For example, for cf-rabbit.
```bash
git branch -D feature-coabdepls-cf-rabbit-serviceinstances
git co cleaned-feature-coabdepls-cf-rabbit-serviceinstances
git branch -m feature-coabdepls-cf-rabbit-serviceinstances
git push -f origin feature-coabdepls-cf-rabbit-serviceinstances
```

## feature-dashboard-vpn
Add new `multi-region vpn` dashboard.

### Compliance
* Iaas Type
  * [x] Openstack Iaas Type
  * [x] vSphere Iaas Type

### Content (implementation)
* [x] Add new json dashboard
* [x] Set `prometheus` deployment operator and var to integrate dashboard
* [x] Set `r1-vpn` private ip on vsphere and public on openstack  for `prometheus` blackbox-vpn scrape

## feature-v48-upgrade
for micro/master/coab, add activation for deployment K8S:
- k8s
- k8s-addon
- k8s-traefik
- k8s-jaeger
- k8s-openebs
- k8s-longhorn
- k8s-logging
- k8s-prometheus

add secret creation for k8S/secret/meta.yml

for Master, add activation for deployment K8S:
- k8s-metabase
- k8s-grafana


To have Job concourse run green directly:
- order job K8S first, 
- then K8S-traefik ,K8S-openebs, K8S-longhorn 
- then others K8S-

### New features
add K8S ecosystem.

### Compliance
* Iaas Type
  * [X] Openstack Iaas Type
  * [X] vSphere Iaas Type


## feature-update-prometheus-exporter-coab
Update scrape interval and timeout for `prometheus_exporter_coab` bosh metrics collection.

### References
- closes https://github.com/orange-cloudfoundry/paas-templates/issues/897

### Compliance
* Iaas Type
  * [x] Openstack Iaas Type
  * [x] vSphere Iaas Type

### Content (implementation)
* [x] Add new operator to set bosh scrape for `bosh-coab`

## feature-optimize-bosh-director-cleanup
Clean `prometheus` bosh directors tasks and reduce history to 30 days to maintain director avalability and performance.

### Compliance
* Iaas Type
  * [x] Openstack Iaas Type
  * [x] vSphere Iaas Type

### References
- closes https://github.com/orange-cloudfoundry/paas-templates/issues/xxx

### Content (implementation)
* [x] Update shared bosh-director operator to reduce history to 30 days and clean `prometheus` tasks
* [x] Update `recreate-micro-bosh.sh` script

## feature-enable-concourse-auto-rerun

Tune micro-depls/concourse for better behaviour (especially on integration environment)

### New features
#### Operators
Enjoy more sacalable COA operations

### Compliance
* Iaas Type
  * [X] Openstack Iaas Type
  * [X] vSphere Iaas Type

### References
- closes https://github.com/orange-cloudfoundry/paas-templates/issues/898

## feature-stratos-3

bump stratos 3.1.0

### New features

#### CloudFoundry and marketplace users
New stratos version 3.1.0

#### Operators

### Compliance
* Iaas Type
  * [X] Openstack Iaas Type
  * [X] vSphere Iaas Type

### References
- https://github.com/cloudfoundry/stratos/releases/tag/3.1.0
- closes https://github.com/orange-cloudfoundry/paas-templates/issues/728

### Content (implementation)
* [x] bump stratos 3.0.1
* [x] disable angular metrics collection for statos

## feature-update-micro-bosh
Scale `micro-bosh` instance to 4 cpu / 16 go and 10 workers like other bosh-directors for `k8s` deployments managing

### Compliance
* Iaas Type
  * [x] Openstack Iaas Type
  * [x] vSphere Iaas Type

### Content (implementation)
* [x] Set operator to extend workers to 10
* [x] Set operators to update `micro-bosh` instance to 4 cpu / 16 go
* [x] Fix bad reference to `node-exporter` bosh release in recreate micro-bosh script

## feature-osb-cmdb-v48

This feature enables osb-cmdb to test against noop or other backing service type than mysql

### New features

#### Operators

osb-cmdb operator can now choose to configure their osb-cmdb smoke test to use a different service than mysql, and in particular to specify the git url of the probe application to use, or "" to specify that no probe app should be invoked (e.g. as with coab-noop)

Example config in osb-cmdb secrets.yml

```yml
secrets:
[...]
  smoke_test_service: noop-ondemand #name of the service to instanciate in smoke tests
#  smoke_test_service: p-mysql #name of the service to instanciate in smoke tests
  service_probe_app_git_repo_url: "" #disable service probe when testing with noop brokered service
  smoke_test_service_plan: default    #name of the service plan to instanciate in smoke tests
```

### References
- fixes https://github.com/orange-cloudfoundry/paas-templates/issues/889 v47 is missing documented osb-cmdb "cf update-service --upgrade" support


## feature-sec-group-broker-bump-v48

Bumps sec-group-broker filters and add smoke tests

### References
- fixes https://github.com/orange-cloudfoundry/paas-templates/issues/876 security filter brokers incompatible with java buildpack 4.32.1

#### Limitations (known remaining issues)
- smoke tests for `ops-depls/cf-apps-deployments/sec-group-broker-filter-cf` still require human assertions to check the ASG content

### Content (implementation)
* [x] Bumped to sec-group-broker filters to 2.5.0 https://github.com/orange-cloudfoundry/sec-group-broker-filter/releases/tag/v2.5.0.RELEASE
* [x] Fix scraping endpoint for coab brokers. Relates to https://github.com/orange-cloudfoundry/paas-templates/issues/884
* [x] Manually tested that intranet brokers restart after the `fpv-brokers` space is removed.
* [x] Manually tested that internet brokers restart after the `fpv-brokers` space is removed. 

### Manual platform ops

* no need to change secrets. Tested with commenting out newly added entries that drive common-broker-script

### Expected upgrade availability impacts during maintenance window

#### CloudFoundry users
- Marketplace service management (eg: dashboards): down 2 mn (sec-group has 2 instances but COA does not yet do rolling updates)

## feature-metrics-on-cf-mysql-dedicated-2

### New features

Configures coab mysql broker to return URL of the dedicated grafana instance introduced in `feature-metrics-on-cf-mysql-dedicated` branch. The grafana dashboard is unauthenticated.

#### CloudFoundry and marketplace users

#### OSB client platforms

Marketplace users now see a dashboard URL in newly created service instances (see below an example extracted from the smoke tests)

```
$ cf service cf-mysql-smoketest-1600237665
Showing info of service cf-mysql-smoketest-1600237665 in org service-sandbox / space coa-cf-mysql-smoke-tests as admin...
name:             cf-mysql-smoketest-1600237665
service:          cf-mysql-ondemand
tags:             
plan:             medium
description:      MariaDB 10.3.22 databases on demand on dedicated Galera cluster 
documentation:    https://mariadb.com/kb/en/library/
dashboard:        https://grafana-bb3da224-8f48-4468-a15f-2293637a150d.redacted-system-domain.com/d/mysql_overview/mysql-overview?orgId=1&refresh=5m&from=now-2d&to=now
service broker:   p-coab-cf-mysql
```

Opening the dashboard URL in a browser requires no authentication and displays the following type of mysql dashboard (initially without data just after the instance is just created)
![image](https://user-images.githubusercontent.com/4748380/93768522-cce28280-fc19-11ea-9cfa-8e3f6526e182.png)


#### Limitations (known remaining issues)
- COAB mysql smoke test does not yet assert presence of the dashboard nor its http status is 200

### Content (implementation)
* [x] Configure dashboard to grafana homepage 
* [x] Refine dashboard URL to mysql-specific dashboard in grafana 
* [x] manually tested coab-mysql smoke test has right dashboard url 
   * [x] dashboard URL is valid and return mysql dashboard with data
* [x] manually tested osb-cmdb-0 smoke test has right dashboard url
   * [x] dashboard URL is valid and return mysql dashboard with data

### Manual platform ops
### Expected upgrade availability impacts during maintenance window

#### CloudFoundry and marketplace users
- Marketplace service management (eg: dashboards): down 2 mins (coab instance have a single app instance)

#### OSB client platforms
- Marketplace service management (eg: dashboards): down 2 mins (coab instance have a single app instance)



## feature-metrics-on-cf-mysql-dedicated

this branch adds grafana/prometheus on cf-mysql dedicated service, reduces technical debt on cf-mysql model and bump mariadb 10.3.

#### CloudFoundry and marketplace users
bump to mariadb 10.3
grafana dashboards (anonymous access) for new services

### Compliance
* Iaas Type
  * [x] Openstack Iaas Type
  * [x] vSphere Iaas Type

### References
- closes https://github.com/orange-cloudfoundry/paas-templates/issues/797
- closes https://github.com/orange-cloudfoundry/paas-templates/issues/807
- closes https://github.com/orange-cloudfoundry/paas-templates/issues/739
- closes https://github.com/orange-cloudfoundry/paas-templates/issues/871

#### Limitations (known remaining issues)
grafana dashboards not available for existing pre-48 services

### Architecture
Architecture: (see https://miro.com/app/board/o9J_krEBr-4=/)
![image](https://user-images.githubusercontent.com/4748380/91453120-a716c780-e87f-11ea-9668-71723583e054.png)

### Content (implementation)
* [x] update coab-depls/cf-mysql model to add grafana/prometheus jobs
* [x] update coab-depls/cf-mysql in order to bump mariaDB 10.3
* [x] update coab-depls/cf-mysql in order to remove technical debt

## feature-fix-internet-squid-prometheus-metrics

Fix micro-depls/internet-proxy metrics collection
Add an initial grafana dashboard to follow internet traffic

### New features

#### Operators
- new grafana dashboard for internet squid

### Compliance
* Iaas Type
  * [X] Openstack Iaas Type
  * [X] vSphere Iaas Type

### References
- closes https://github.com/orange-cloudfoundry/paas-templates/issues/892
- https://www.boynux.com/squid-exporter/
- https://github.com/boynux/squid-exporter/releases/tag/v1.9.1

### Content (implementation)
* [X]  bump squid and squid-exporter
* [X] fix squid configuration for acl manager access
* [X] add initial grafana squid dashboard

## feature-profile-for-vpn-traffic-limitation

Add a new profile to  limit vpn traffic, for non prod environments. This limits the inbound and oubound traffic on r3 vpn to 1000kbs.

### New features

#### Operators
New profile can be activated on non prod environement to limit inter-region intranet traffic usage

### Compliance
* Iaas Type
  * [x] Openstack Iaas Type
  * [x] vSphere Iaas Type
* Profiles
  * [X] Apply on Profile 90-vpn-traffic-limitation. To activate on non-prod environments.

### References
- closes https://github.com/orange-cloudfoundry/paas-templates/issues/881
- https://github.com/orange-cloudfoundry/wondershaper-boshrelease/releases/tag/1

### Limitations
- missing extensive test
- missing linux networking Qos metrics/monitoring/alerting

## feature-cleanup-v48
Cleanup unused deployments, scripts.

### Compliance
* Iaas Type
  * [x] Openstack Iaas Type
  * [x] vSphere Iaas Type

### References
- https://github.com/orange-cloudfoundry/paas-templates/issues/819
  closes orange-cloudfoundry/paas-templates#819

### Content (implementation)
* [x] Delete obsolete `micro-depls/credhub-ha/scripts/export-bosh-dns-certs-as-files.sh` script
* [x] Delete `cfcr` deployments
* [x] Delete `kubo-depls` deployments
* [x] Delete `master-depls/bosh-kubo` deployment
* [x] Add upgrade scripts for cleanup (secrets, credhub properties and concourse pipeline)

### Manual platform ops

#### Clean-up steps (final clean, when platform state is ok. Can be applied out of upgrade maintenance window)
- Clean unused `kubo-depls` pipelines and team on `bosh-cli` after cleanup script ended

```
$ log-fly (select main)
$ for p in $(fly pipelines | grep kubo | awk '{print $1}') ; do fly dp -n -p $p ; done

$ log-fly (select kubo-depls)
$ for p in $(fly pipelines | grep kubo | awk '{print $1}') ; do fly dp -n -p $p ; done

$ fly dt -n kubo-depls
$ fly teams
```

## feature-v48-enable-precompile-pipelines

Enable COA 5, with bosh release precompilation feature

### New features
- bosh release are now precompilable in a dedicated / per root-deployment pipeline
- COA 5 repackages the bosh releases from github reference (no more tgz or bosh.io release). A fallback is activated in case of failure  (bosh.ui, tgz releases)
- COA bosh releases management is now targeted (no continuous download / replication of unused versions). Only versions as specified in <root-deployment>/root-deployment.yml are loaded (no more upload pipelines)

#### CloudFoundry and marketplace users

#### OSB client platforms

#### Operators
- precompilation shares resulting packages between root-deployment. This should bring a significant gain on upgrade pipeline duration
- precompilation being done ahead (before pre-merge phase), operators will benefit from reduced maintenance window for their end users.

### Compliance
* Iaas Type
  * [X] Openstack Iaas Type
  * [X] vSphere Iaas Type

### References
- closes https://github.com/orange-cloudfoundry/paas-templates/issues/653
- closes https://github.com/orange-cloudfoundry/paas-templates/issues/764
- closes https://github.com/orange-cloudfoundry/paas-templates/issues/44
- closes https://github.com/orange-cloudfoundry/paas-templates/issues/401
- closes https://github.com/orange-cloudfoundry/paas-templates/issues/817

## feature-disable-client-cert-request
Fix `SEC_ERROR_PKCS11_GENERAL_ERROR` error on Firefox browser, when `security.osclientcerts.autoload` set to `true` with entreprise strategy policie.

### Compliance
* Iaas Type
  * [x] Openstack Iaas Type
  * [x] vSphere Iaas Type

### References
- closes https://github.com/orange-cloudfoundry/paas-templates/issues/891

### Content (implementation)
* [x] Set `router/client_cert_validation` to `none`  for `ops-routing`, `osb-routing` and `cf` deployments

See  https://bosh.io/jobs/gorouter?source=github.com/cloudfoundry/routing-release&version=0.207.0#p%3drouter.client_cert_validation
> client_cert_validation
> none - Gorouter will not request client certificates in TLS handshakes, and will ignore them if presented

## feature-fix-cf-autoscaler
this branch fixes cf-autoscaler for v48.

### Compliance
* Iaas Type
  * [x] Openstack Iaas Type
  * [x] vSphere Iaas Type

### Content (implementation)
* [x] Update master-depls/cf-autoscaler

## feature-coab-v48
this branch bumps paas-templates to coab [v0.31.0](https://github.com/orange-cloudfoundry/cf-ops-automation-broker/releases/tag/v0.31.0) and fixes shield backups on metabase and cf-autoscaler.

### References
- fixes https://github.com/orange-cloudfoundry/paas-templates/issues/866
- fixes https://github.com/orange-cloudfoundry/paas-templates/issues/831

## feature-jcr-add-gitlab-docker-registry

add registry.gitlab.com to JCR
bump gitlab helm chart

### References
close https://github.com/orange-cloudfoundry/paas-templates/issues/911


## feature-fix-jcr-47

### New features
#### Operators
fix docker jcr for smooth from scratch recreation

### References
- closes https://github.com/orange-cloudfoundry/paas-templates/issues/888

## feature-fixes-for-48.0.0

fix terraform for internet access

## feature-admin-v48
Admin scripts maintenance for v48 paas-template release.

### New features
- Recover process to optimize `unresponsive agent` recovering

### References
- closes https://github.com/orange-cloudfoundry/paas-templates/issues/102
- closes https://github.com/orange-cloudfoundry/paas-templates/issues/124
- closes https://github.com/orange-cloudfoundry/paas-templates/issues/885
- closes https://github.com/orange-cloudfoundry/paas-templates/issues/848

### Compliance
* Iaas Type
  * [x] Openstack Iaas Type
  * [x] vSphere Iaas Type

### Content (implementation)
* [x] Optimize and fix all admin scripts bugs
* [x] Centralize and replace `micro-depls-versions.yml` with `root-deployment.yml` new reference file
* [x] Delete references to obsolete `kubo` bosh director
* [x] Move `cert_rotation.md` documentation in `admin` directory
* [x] Add `admin/recover-bosh-agent.sh` and `get-bosh-manifest.sh` scripts in `admin` directory
* [x] Get `delete-deployments-review` and `approve-and-delete-disabled-deployments` concourse jobs unpaused when using `admin/pause-jobs.sh`
* [x] Get `check-terraform-consistency` and `approve-and-enforce-terraform-consistency` concourse jobs paused when using `admin/unpause-jobs.sh`
* [x] Add SAN fqdn with CN value when recreate `credhub-ha` and `bosh-dns` certs and set `credhub-ha` certs into credhub
* [x] Merge `check-pki-certs.sh` and ` check-certs-expiry.sh` scripts into `check-certs.sh` script


## `feature-multi-region-final-fixes-proxy`

Adapt vsphere r2 access (no proxy).
Adapt bosh-coab iaas api proxy (no proxy for vsphere, internet proxy for openstack)

### New features for CloudFoundry and marketplace users

### New features for OSB client platforms

### New features for Operators

### Compliance
* Iaas Type
  * [X] Openstack Iaas Type
  * [X] vSphere Iaas Type
* Profiles
  * [X] Apply on multi-region profiles

### References
- closes https://github.com/orange-cloudfoundry/paas-templates/issues/861
- closes https://github.com/orange-cloudfoundry/paas-templates/issues/887


### Content (implementation)
* [X] fix prometheus-r2/r3 federation
* [X] adapt http proxy for bosh directors (only for openstack API)
* [X] fix multi-nic vms node_exporter metric on coab-depls
* [X] fix r3 openstack default sg

## feature-ops-portal-v48
Update ops-portal to add `light` and `dark` modes, and static head bar colored for each platform type (integration, preproduction, production)

### Compliance
* Iaas Type
  * [x] Openstack Iaas Type
  * [x] vSphere Iaas Type

### Content (implementation)
* [x] Update html templates to manage new features and optimizations
* [x] Create new css files for `light` and `dark` modes
* [x] Create javascript file to manage style mode and set cookies to keep user choices persistent
* [x] Set platform type `/secrets/site_type` in credhub

### Manual platform ops

#### Pre-merge steps (before updating reference branch)

- Set <site_type> (integration, preproduction, production) in `shared/secrets.yml` secrets repository file, commit and push

``` yaml
secrets:
  #--- Tenant identification
  site: <site_name>
  site_type: <site_type>
```

## feature-upgrade-vsphere-hw-version
Set vsphere cpi property to support latest firmware release (e.g.: ESXi 6.7 update 2 / VM version 15) for performance improvement.

### Compliance
* Iaas Type
  * [x] vSphere Iaas Type
* Profiles
  * [x] Apply on Profile `80-r2-vsphere` and `81-r3-vsphere`

### References
- closes https://github.com/orange-cloudfoundry/paas-templates/issues/829

### Content (implementation)
* [x] set `upgrade_hw_version` propertie to true

### Manual platform ops

#### Clean-up steps (final clean, when platform state is ok. Can be applied out of upgrade maintenance window)
- To apply cpi property (after bosh director have been deployed), you must recreate each deployment with instance recreation. This is typically done with upgrade pipeline

## feature-k8s-fix-3

## feature-k8s-fix2
some fixup after refactoring:
- externalize openebs as k8s-openebs
- add sha1 to node-exporter bosh release for micro-bosh creation 
- Add middleware to fix longhorn ui communication
- Add metadata on longhorn storageclass to use dataLocality: "best-effort"
- Fixup bad name (conflict between 2 actions) for helm action on k8s-prometheus
- Bump to helm-kubectl-bosh release 27 to stop errand when K8S is not ready
- Move Metabase to longhorn storageclass with 1 replica and backup every day
- add toleration ans nodeselector for metabase and elk to allow pod running on node persistence
- Fix clusterIp for openldap as service as change CIDR when migrate from CFCR to K8S

## feature-k8s-fixes-for-v48

miscelaneous fixes to stabilise k8s micro and master et serv : 


### Compliance
* Iaas Type
  * [x] Openstack Iaas Type
  * [x] vSphere Iaas Type

### References
- https://github.com/orange-cloudfoundry/helm-kubectl-boshrelease/releases/tag/26
- https://github.com/jhunt/k8s-boshrelease/releases/tag/v1.18.8-build.1


### Content (implementation)

Fixes:
* [x] externalize number of node, node persistent, node public into a secret/meta.yml file 

* [x] move from cfcr to K8S for k8s-serv
  check all deployments to be compatible with k8s-serv and is naming 10-k8s*

* [x] k8s-flux 10-k8s-flux
  externalize flux to a dedicated deployment k8s-flux instead of be included k8s-addon

* [x] bump jcr 7.7.3 

* [X] k8s-logging
   bump elk to 7.8.1
   bump kibana to 7.8.1
   move pv to openebs-hostpath for elk

* [x] k8s-grafana 
  bump grafana helm : 5.5.5 (ie grafana : 7.1.1)
  
  add grafana dashboard for coredns 1.7.0
* [x] k8s-concourse:
  bump helm concourse-version:  11.2.3
  bump helm stolon-version: 1.6.1
  bump helm prometheus-postgres-exporter-version: 1.3.0
  k8s-concourse configure credhub client
* [x] k8s-kubeapps 
  add cert for JCR exposition
  bump helm 3.8.0

* [x] k8s-openebs / 10-k8s-openebs
   bump to openebs 2.0.0

* [x] k8s / 10-k8s
   coredns changement:
     disable coredns install by k8s bosh release to be able to install it with all desired plugin by helm chart
     change service coredns to another clusterip adress
     install coredns 1.7.0  by helm chart
   metrics-server changement:
     add apiserver flag to enable aggregation for metric-server
    deploy metrics server by K8S object to have full customization and be able to provide certificate
  velero-changement:
    update version to be compatible with openebs
    add velero openebs plugin
* [x] k8s-kube-state-metrics  
  bump helm chart 2.8.13
* [x] k8s-crunchy /10-k8s-crunchy
  bump 4.4.0
* [x] add missing openstack port creation with terraform (k8s haproxy vrrp)

* [X] k8s-traefik 
   on master-depls:  remove paas-templates/master-depls/k8s-traefik/template/policy-operators.yml 
* [X] missing per profile micro-depls/k8s-addon/template/01-kubernetes-certificate-operators.yml for dashboard 

* [X] fix coab-depls/10-cfcr dns aliases for log-k8s compatibility
* [X] resolve quay.io proxy access failure
  * [X] adapt micro-depls/nexus for containerd http agent for docker routing
  * [X] configure micro-depls/jcr to proxy a corporate quay.io docker proxy

* [X] bump kube-state-metrics chart 2.8.13 (was 2.4.0), app version 1.9.7
* [X] fix: https://github.com/orange-cloudfoundry/paas-templates/issues/855

Improvements:
* [x] k8s-jaeger. Add authentication
* [x] kibana. Add authentication

### Limitations
* [ ] k8s-jaeger. Add url in ops-portal https://jaeger.k8s-micro.<ops_domain>/jaeger/search


## feature-harden-coab-model-migration-pipeline
this branch fixes a bug in coab model migration pipeline

### New features
COAB model migration pipeline improvment for operators

### Compliance
* Iaas Type
  * [x] Openstack Iaas Type
  * [x] vSphere Iaas Type

### References
- https://github.com/orange-cloudfoundry/paas-templates/issues/806

### Content (implementation)
* [x] Update coab-depls/model-migration-pipeline

## feature-mongodb-shared-v12
this branch bumps mongodb v12 and orange-prometheus-addons v1

### New features

#### CloudFoundry and marketplace users
mongodb 4.2.9 / v12 shared service

### Compliance
* Iaas Type
  * [x] Openstack Iaas Type
  * [x] vSphere Iaas Type

### References
- closes https://github.com/orange-cloudfoundry/paas-templates/issues/877
- https://github.com/orange-cloudfoundry/mongodb-boshrelease/releases/tag/12
- https://github.com/orange-cloudfoundry/orange-prometheus-addons-boshrelease/releases/tag/1

### Content (implementation)
* [x] Update ops-depls/mongodb bosh deployment

## feature-fix-precompil-vm-usage

resize bosh directors compilation vm pool size to enable smooth precompilation

### Compliance
* Iaas Type
  * [X] Openstack Iaas Type
  * [X] vSphere Iaas Type

### References
- closes https://github.com/orange-cloudfoundry/paas-templates/issues/864
- closes https://github.com/orange-cloudfoundry/paas-templates/issues/451

### Content (implementation)
* [X] limit bosh compilation worker pool size to match availables compilation ip and bosh worker pool size


## feature-fix-rubybuildpack-coab-smoke-tests
As an ops, I expect Redis smoke tests to run without errors,
in order to have an accurate vision of brokers status

### Content (implementation)
* [X] bump ruby smoke tests branch to a version compliant with ruby buildpack 1.8.15

### references

* closes https://github.com/orange-cloudfoundry/paas-templates/issues/850

## feature-cf-deployment-13

bump cloudfoundry to cf-deployment v13.13.0

### New features

#### CloudFoundry and marketplace users
- api v3 / cf cli v7 compatiblity see https://github.com/cloudfoundry/cli 
- discovery is enabled for C2C networking
- https://github.com/cloudfoundry/dotnet-core-buildpack-release/releases/tag/2.3.13
- https://github.com/cloudfoundry/go-buildpack/releases/tag/v1.9.15
- https://github.com/cloudfoundry/java-buildpack/releases/tag/v4.32.1
- https://github.com/cloudfoundry/nginx-buildpack/releases/tag/v1.1.12
- https://github.com/cloudfoundry/r-buildpack-release/releases/tag/1.1.7
- https://github.com/cloudfoundry/staticfile-buildpack-release/releases/tag/1.5.9

#### OSB client platforms

#### Operators

### Compliance
* Iaas Type:
  * [X] Openstack Iaas Type
  * [X] vSphere Iaas Type

### References
- closes https://github.com/orange-cloudfoundry/paas-templates/issues/743

- https://www.pivotaltracker.com/n/projects/1382120/epics/2870447 - nats
- https://github.com/cloudfoundry/cf-deployment/releases/tag/v13.16.0
- https://github.com/cloudfoundry/cf-deployment/releases/tag/v13.15.0
  - https://github.com/cloudfoundry/diego-release/releases/tag/v2.48.0
  - https://github.com/cloudfoundry/postgres-release/releases/tag/v42

- https://github.com/cloudfoundry/cf-deployment/releases/tag/v13.14.0
- https://github.com/cloudfoundry/cf-deployment/releases/tag/v13.13.0
    - https://github.com/cloudfoundry/cf-smoke-tests-release/releases/tag/41.0.1
- https://github.com/cloudfoundry/dotnet-core-buildpack-release/releases/tag/2.3.13
- https://github.com/cloudfoundry/go-buildpack/releases/tag/v1.9.15
- https://github.com/cloudfoundry/java-buildpack/releases/tag/v4.32.1
- https://github.com/cloudfoundry/nginx-buildpack/releases/tag/v1.1.12
- https://github.com/cloudfoundry/r-buildpack-release/releases/tag/1.1.7
- https://github.com/cloudfoundry/staticfile-buildpack-release/releases/tag/1.5.9
- https://github.com/cloudfoundry/cf-deployment/releases/tag/v13.12.0
    - https://github.com/cloudfoundry/capi-release/releases/tag/1.97.0

-https://github.com/cloudfoundry/cf-deployment/releases/tag/v13.11.0
  - cf cli v7 compatible smoke tests-release/releases/tag/41

  - https://github.com/cloudfoundry/garden-runc-release/releases/tag/v1.19.15
    - https://github.com/bosh-packages/cf-cli-release/releases/tag/v1.28.0
    - https://github.com/cloudfoundry/cflinuxfs3-release/releases/tag/v0.201.0

- https://github.com/cloudfoundry/cf-deployment/releases/tag/v13.10.0

- https://github.com/cloudfoundry/cf-deployment/releases/tag/v13.9.0
  - service discovery enabled by default
  - https://github.com/pivotal/credhub-release/releases/tag/2.8.0
   - https://github.com/cloudfoundry/loggregator-agent-release/releases/tag/v6.1.1
    https://github.com/cloudfoundry/uaa-release/releases/tag/v74.23.0

- https://github.com/cloudfoundry/cf-deployment/releases/tag/v13.8.0
- https://github.com/cloudfoundry/cf-deployment/releases/tag/v13.7.0
  - https://github.com/cloudfoundry/cf-networking-release/releases/tag/2.31.0
  - https://github.com/cloudfoundry/silk-release/releases/tag/2.31.0
    - https://github.com/cloudfoundry/metric-store-release/releases/tag/v1.4.3
    - https://github.com/cloudfoundry-incubator/envoy-nginx-release/releases/tag/v0.7.0

- https://github.com/cloudfoundry/cf-deployment/releases/tag/v13.6.0
    - https://github.com/cloudfoundry/metrics-discovery-release/releases/tag/v3.0.1
    
- https://github.com/cloudfoundry/cf-deployment/releases/tag/v13.5.0
  - Enables TLS between route-emitter and NATS.

- https://github.com/cloudfoundry/cf-deployment/releases/tag/v13.4.0
- https://github.com/cloudfoundry/cf-deployment/releases/tag/v13.3.0

- https://github.com/cloudfoundry/cf-deployment/releases/tag/v13.2.0
  - https://github.com/cloudfoundry-incubator/backup-and-restore-sdk-release/releases/tag/v1.18.0

- https://github.com/cloudfoundry/cf-deployment/releases/tag/v13.1.0

- https://github.com/cloudfoundry/cf-deployment/releases/tag/v13.0.0
  - https://github.com/cloudfoundry/capi-release/releases/tag/1.93.0
  - Replaces the scalable syslog architecture with the shared-nothing syslog architecture. This architecture is more efficient and will enable the usage of the aggregate drains feature. This change adds two new add-ons to every VM in Cloud Foundry. 
    
- https://github.com/cloudfoundry/cf-deployment/releases/tag/v12.45.0

- https://github.com/cloudfoundry/cf-deployment/releases/tag/v12.44.0
  - NATS servers are now addressed with hostnames instead of IP addresses.
  - https://github.com/cloudfoundry/nats-release/releases/tag/v34

- https://github.com/cloudfoundry/cf-deployment/releases/tag/v12.43.0


#### Limitations (known remaining issues)
- workarounded metrics discovery registrar issue (ko on nats instance groups)
- https://github.com/orange-cloudfoundry/paas-templates/issues/895

### Content (implementation)
* [X] bump cf-deployment submodule
* [X] adapt cf manifest addons
* [X] adapt isolation segments vars retrieval from master-depls/cf

### Expected upgrade availability impacts during maintenance window

#### CloudFoundry and marketplace users
- cf api: down 5 mn
- Marketplace service usage: down 5 mn
- Marketplace service management (eg: dashboards): down xxx mn

#### OSB client platforms
- Marketplace service provisionning: down 5 mn

## feature-remove-technical-debt-on-dedicated-services
this feature removes technical debt on dedicated services models by removing bash script in COA hooks (pre-deploy.sh and post-deploy.sh)

### Compliance
* Iaas Type
  * [x] Openstack Iaas Type
  * [x] vSphere Iaas Type

### References
- closes https://github.com/orange-cloudfoundry/paas-templates/issues/710

#### Limitations (known remaining issues)
- not applied on cassandra model

### Content (implementation)
* [x] update mongodb model
* [x] update cf-rabbit model

## feature-rabbitmq38-dedicated
this branch bumps dedicated cf-rabbit service

### Compliance
* Iaas Type
  * [x] Openstack Iaas Type
  * [x] vSphere Iaas Type

### References
- closes https://github.com/orange-cloudfoundry/paas-templates/issues/810
- https://bosh.io/releases/github.com/pivotal-cf/cf-rabbitmq-release?version=279.0.0
- https://bosh.io/releases/github.com/pivotal-cf/cf-rabbitmq-multitenant-broker-release?version=59.0.0
- https://bosh.io/releases/github.com/pivotal-cf/cf-rabbitmq-smoke-tests-release?version=37.0.0

### Content (implementation)
* [x] Update coab-depls/cf-rabbit deployment model

## feature-bump-for-v48-3
align versions micro/master/coab: 
- uaa 74.23.0
- fix node_exporter bosh release description
- bump postgres 42
- bump haproxy 10.1.0 on coab

## feature-bump-for-v48-2

Releases bump for v48

### New features

#### CloudFoundry and marketplace users
Mongodb v12
Orange Prometheus Addons

#### OSB client platforms

#### Operators

### Compliance
* Iaas Type
  * [x] Openstack Iaas Type
  * [x] vSphere Iaas Type

### References
- https://github.com/orange-cloudfoundry/orange-prometheus-addons-boshrelease/releases/tag/1
- https://github.com/orange-cloudfoundry/mongodb-boshrelease/releases/tag/12
- https://github.com/orange-cloudfoundry/wireguard-boshrelease/releases/tag/5
- https://github.com/orange-cloudfoundry/wireguard-boshrelease/releases/tag/6
- closes https://github.com/orange-cloudfoundry/paas-templates/issues/533
- closes https://github.com/orange-cloudfoundry/paas-templates/issues/662
- closes https://github.com/orange-cloudfoundry/paas-templates/issues/882
- closes https://github.com/orange-cloudfoundry/paas-templates/issues/877

### Content (implementation)
* [x] Bump `stemcells` to 621.81
* [x] Bump `vsphere cpi` to 54.1.0
* [x] Bump `kafka-boshrelease` to 1.18.8-orange-3
* [x] Bump `k8s-boshrelease` to 1.18.8-orange-3
* [x] Bump `mongodb-boshrelease` to 12
* [x] Bump `orange-prometheus-addons-boshrelease` to 1
* [x] add wireguard hotfix tooling on vpn r3 (apt config+package download)

## feature-bump-for-v48

bumps for v48:
- stemcell 671.81
- bosh
  - https://github.com/cloudfoundry/bosh/releases/tag/v271.2.0
  - https://github.com/cloudfoundry/bosh/releases/tag/v271.1.0
  - https://github.com/cloudfoundry/bosh/releases/tag/v270.12.0

- credhub bump, closes https://github.com/orange-cloudfoundry/paas-templates/issues/790, closes https://github.com/orange-cloudfoundry/paas-templates/issues/695
  - https://github.com/pivotal/credhub-release/releases/tag/2.6.0
  - https://github.com/pivotal/credhub-release/releases/tag/2.7.1
  - https://github.com/pivotal/credhub-release/releases/tag/2.8.0
- haproxy https://github.com/cloudfoundry-incubator/haproxy-boshrelease/releases/tag/v10.1.0
- kafka https://github.com/cloudfoundry-community/kafka-boshrelease/releases/tag/v2.4.2
- nats https://github.com/cloudfoundry/nats-release/releases/tag/v34
- node-exporter https://github.com/bosh-prometheus/node-exporter-boshrelease/releases/tag/v5.0.0
- os-conf https://github.com/cloudfoundry/os-conf-release/releases/tag/v22.0.0
- bump thanos from 0.6.1 to 0.14.0, closes https://github.com/orange-cloudfoundry/paas-templates/issues/862
  - https://github.com/thanos-io/thanos/releases/tag/v0.7.0
  - https://github.com/thanos-io/thanos/releases/tag/v0.8.0
  - https://github.com/thanos-io/thanos/releases/tag/v0.9.0
  - https://github.com/thanos-io/thanos/releases/tag/v0.10.0
  - https://github.com/thanos-io/thanos/releases/tag/v0.11.0
  - https://github.com/thanos-io/thanos/releases/tag/v0.12.0
  - https://github.com/thanos-io/thanos/releases/tag/v0.13.0
  - https://github.com/thanos-io/thanos/releases/tag/v0.14.0

### Compliance
* Iaas Type
  * [x] Openstack Iaas Type
  * [x] vSphere Iaas Type

### References
- https://github.com/cloudfoundry/bosh-linux-stemcell-builder/releases/tag/ubuntu-xenial%2Fv621.81


## feature-fixes-post-47.0.3

### New features
This branch fixes a missing grab for openstack-hws for coab mysql extended broker password

### Compliance
* Iaas Type
  * [X] Openstack Iaas Type
  * [X] vSphere Iaas Type

## feature-cf-isolation-segment-for-internal

### New features

Add a new isolation segment, with a dedicated org, and a private domain (only visible /accessible from paas-templates vms).
This will ease cf apps based private deployment, and also gives support for http routing to bosh vms on a private domain.

### Compliance
* Iaas Type
  * [X] Openstack Iaas Type
  * [X] vSphere Iaas Type

### References
- https://github.com/orange-cloudfoundry/paas-templates/issues/846

### Content (implementation)
* [X] Add bosh deployment master-depls/isolation-segment-internal. Including 2 gorouters, 2 diego cell, and a sharding policy 'segment'
* [X] include a static relay in tf-net-cf, static ip 192.168.35.50
* [X] Add dns wildcard alias in micro-depls/dns-recursor
* [X] Add security group declaration to enable access to the new internal relay
* [X] Add terraform declaration for domain
* [X] Add post-deploy generic scripting to create isolation segment, and enable internal cf organization

### Manual platform ops

#### Post-upgrade steps (after upgrade pipeline is done)
- apply master-depls terraform

## feature-dependabot

Enables github docker dependency updates

* As a paas-templates maintainer
* In order to avoid using deprecated vulnerable dependencies
* I need to receive PRs with version bumps from [github dependabot](https://docs.github.com/en/github/administering-a-repository/keeping-your-dependencies-updated-automatically)

### References
* https://docs.github.com/en/github/administering-a-repository/configuration-options-for-dependency-updates
* https://docs.github.com/en/github/administering-a-repository/listing-dependencies-configured-for-version-updates 
* https://docs.github.com/en/github/administering-a-repository/enabling-and-disabling-version-updates#enabling-github-dependabot-version-updates
* https://docs.github.com/en/github/administering-a-repository/customizing-dependency-updates
* https://github.com/dependabot/dependabot-core
   * https://github.com/dependabot/dependabot-core/blob/f3b563823ac79d152be2250558d5af40c1f85578/terraform/spec/dependabot/terraform/file_parser_spec.rb#L63-L99
   * https://github.com/dependabot/dependabot-core/blob/main/docker/spec/dependabot/docker/file_parser_spec.rb

### Content (implementation)
* [x] Add declarative file dependabot in public repo (once this PR is merged and released)
* [x] Configure for private repo dependabot notification visibility to paas-templates maintainers, authors and operators
* [ ] Possibly tune dependabot behavior

relates to https://github.com/orange-cloudfoundry/paas-templates/issues/869

## feature-sanitize-v48
this branch holds sanitize actions for v48 in order to avoid conflicts, and the cleaning of COA post-deploy.sh script under redis model deployment


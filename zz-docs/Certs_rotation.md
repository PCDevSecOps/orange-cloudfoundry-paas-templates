# Paas-template certs rotation

This document describes how to ensure certs rotation on **paas-template** distribution
- [**Prerequisites**](##Prerequisites)

- [**Use case 1:** InternalCA and bosh-directors certs rotation](##Use-case-1:-InternalCA-and-bosh-directors-certs-rotation)

  - [**Step 1:** Regenerate and deploy new internalCA to all instances (average duration: **0,5 days**)](###Step-1:-Regenerate-and-deploy-new-internalCA-to-all-instances)
  - [**Step 2:** Recreate micro-bosh director and credhub with new certs (average duration: **2 hours**)](###Step-2:-Recreate-micro-bosh-director-and-credhub-with-new-certs)
  - [**Step 3:** Recreate other bosh-director with new certs (average duration: **3 hours**)](###Step-3:-Recreate-other-bosh-director-with-new-certs)

- [**Use case 2:** Bosh specific deployment certs rotation (average duration: **deployment duration**)](##Use-case-2:-Bosh-specific-deployment-certs-rotation)

- [**Use case 3:** Internet auto-signed cert rotation (average duration: **15 mns**)](##Use-case-3:-Internet-auto-signed-cert-rotation)

- [**Use case 4:** External PKI certs rotation](##Use-case-4:-External-PKI-certs-rotation)
  - [**Requirements**](###Requirements)
  - [**Step 1:** Generate Cert Service Request (average duration: **10 mns**)](###Step-1:-Generate-Cert-Service-Request)
  - [**Step 2a:** Generate certificate from PKI portal (average duration: **10 mns**)](###Step-2a:-Generate-certificate-from-PKI-portal)
  - [**Step 2b:** Renew certificate from PKI portal (average duration: **10 mns**)](###Step-2b:-Renew-certificate-from-PKI-portal)
  - [**Step 3:** Integrate certs into distribution (average duration: **10 mns**)](###Step-3:-Integrate-certs-into-distribution)

## Prerequisites

- Check `/etc/resolv.conf` dns file on **inception** or **docker-bosh-cli** instance and set **dns-recursor** ips if needed

```bash
$ sudo vi /etc/resolv.conf

# Dynamic resolv.conf(5) file for glibc resolver(3) generated by resolvconf(8)
#     DO NOT EDIT THIS FILE BY HAND -- YOUR CHANGES WILL BE OVERWRITTEN
nameserver 192.168.116.156
nameserver 192.168.116.166
nameserver 100.125.0.41
nameserver 100.126.0.41
search openstacklocal
```

- From **inception** or **docker-bosh-cli** instance, you have to clone template and secrets repositories (respect following syntax, reference to admin scripts are based on)

```bash
$ rm -fr ~/bosh/template ~/bosh/secrets
$ git clone <paas_template_url> ~/bosh/template
$ git clone <secrets_url> ~/bosh/secrets
```

## Use case 1: InternalCA and bosh-directors certs rotation

### Step 1: Regenerate and deploy new internalCA to all instances

- Connect to **inception** or **docker-bosh-cli** instance

- Pause concourse pipelines and jobs (refresh your browser after executing script)

```bash
$ ~/bosh/template/admin/pause-jobs.sh
```

- Check that no current deployments are in progress in concourse pipelines, otherwise wait until the end or cancel active tasks

- Renew `internalCA` cert (this script extends expiration date by 10 more years with existing private key and move old `internalCA` into `internalCA2`)

```bash
$ ~/bosh/template/admin/renew-internal-ca.sh
```

- Commit updated files to git secrets repository

```bash
$ cd ~/bosh/secrets
$ git status
$ git commit -a -m "update internalCA"
$ git pull --rebase ; git push
```

- Wait `micro-depls/micro-depls-bosh-generated/cloud-config-and-runtime-config-for-micro-depls` concourse jobs turns green

>**Notes:**  
> This job set bosh-director runtime configuration for updating ca-certs on stemcells when deploying jobs.
> It must be executed before any deployment.  
> Usually, it starts automatically (it shoud take a few minutes to start), but you have to trigger it if not.  
> To check if the job needs to be retriggered, just verify in the concourse jobs if the git secrets commit associated with internalCA update has been used.

- Manually unpause each following concourse **jobs** sequentially in `micro-depls/micro-depls-bosh-generated` pipeline (trigger them if needed), wait it turns green, then pause the jobs (to insure stable bosh deployments) before unpausing next one
  - `deploy-credhub-ha`
  - `deploy-credhub-seeder`
  - `deploy-gitlab`
  - `deploy-concourse`

>**Note:**  
> Sometimes `deploy-concourse` job failed when it deploys itself (deployment is orange and resources too).
> - In this case you have to recreate `deploy-concourse`.
> ```bash
> $ log-bosh
> $ bosh -d concourse recreate
> ```  
> - Purge concourse `stalled workers`
> ```bash
> $ log-fly
> $ fly prune-worker -a
> ```  
> - Then retrigger `deploy-concourse` concourse job

- Check that `credhub-seeder` updated new certs in credhub

```bash
$ log-credhub
$ credhub f | grep /internalCA
- name: /concourse/upload/internalCA2
- name: /concourse/main/internalCA2
- name: /concourse/upload/internalCA
- name: /concourse/main/internalCA
- name: /internalCA2
- name: /internalCA
```

- Trigger `micro-depls/micro-depls-bosh-generated/retrigger-all-jobs` concourse job and wait it turns green

>**Note:**  
> Sometimes jobs deployment failed when they are triggered all together (e.g.: **502** status with gitlab).  
> Just retrigger jobs in red state after checking why they failed.  

- Unpause all jobs in `micro-depls/micro-depls-bosh-generated` concourse pipeline (except `gitlab` and `concourse`) and refresh your browser after executing the script

```bash
$ ~/bosh/template/admin/unpause-jobs.sh -p "micro" -w 10
```

- Wait all jobs turn green before next step

- Trigger (if needed) `master-depls/master-depls-bosh-generated/cloud-config-and-runtime-config-for-master-depls` concourse job and wait it turns green
- Trigger `master-depls/master-depls-bosh-generated/retrigger-all-jobs` concourse job and wait it turns green

- Unpause bosh-director jobs (except `deploy-isolation-segment-internet` and `deploy-isolation-segment-intranet-2`) and wait all jobs turn green

  ```bash
  $ ~/bosh/template/admin/unpause-jobs.sh -p "master" -e "deploy-isolation-segment-internet deploy-isolation-segment-intranet-2" -w 10
  ```

- Trigger `master-depls/master-depls-bosh-generated/deploy-isolation-segment-internet` concourse job and wait it turns green
- Trigger `master-depls/master-depls-bosh-generated/deploy-isolation-segment-intranet-2` concourse job and wait it turns green

- For each following bosh-director (`ops`, `coab`, `kubo`), execute next operations

  - Trigger (if needed) `<director>-depls/<director>-depls-bosh-generated/cloud-config-and-runtime-config-for-<director>-depls` concourse job and wait it turns green
  - Trigger `<director>-depls/<director>-depls-bosh-generated/retrigger-all-jobs` concourse job and wait it turns green

  - Sequentially unpause bosh-director jobs (refresh your browser after executing the script if needed)

  ```bash
  $ ~/bosh/template/admin/unpause-jobs.sh -w 10
  ```

  - Wait all jobs turn green before moving on the next bosh-director

- When all main root bosh-directors have been completed 
  - Trigger `ops-depls/ops-depls-cf-apps-generated/retrigger-all-jobs` concourse job and wait it turns green
  - Trigger `coab-depls/coab-depls-cf-apps-generated/retrigger-all-jobs` concourse job and wait it turns green

  - Manually unpause following jobs in `micro-depls-bosh-generated` concourse pipeline
    - `deploy-gitlab`
    - `deploy-concourse`

- Check `internalCA` renew by selecting each bosh-director and executing following script

```bash
$ log-bosh
$ ~/bosh/template/admin/check-internal-ca-cert.sh -e 360
```

### Step 2: Recreate micro-bosh director and credhub with new certs

- Connect to **inception** instance

>**Note:**  
> This step must be operate necessarily from **inception** instance because **docker-bosh-cli** is managed by micro-bosh and will be unaccessible between operation.

- Check [prerequisites](##Prerequisites)

- Pause concourse `micro-depls/micro-depls-bosh-generated` pipeline (avoid **micro-depls deployments** to start when micro-bosh redeploys), and check that no current deployments are in progress in the pipeline, otherwise wait until the end or cancel active tasks

- Recreate `micro-bosh` director

```bash
$ ~/bosh/template/admin/recreate-micro-bosh.sh --recreate-certs
```

>**Note:**  
> In case of problem, you could use debug logs with **-v** parameter  
> ```bash
> $ ~/bosh/template/admin/recreate-micro-bosh.sh --recreate-certs -v
> ```

- Commit updated files to git secrets repository ()

```bash
$ cd ~/bosh/secrets
$ git status
$ git commit -a -m "recreate micro-bosh"
$ git pull --rebase ; git push
```

>**Note:**  
> This step is very important, because generated files are mandatory to recreate micro-bosh  

- Unpause concourse `micro-depls/micro-depls-bosh-generated` pipeline

- Check the status of micro-depls bosh deployments (health manager **hm** adapt each instances to the new director with status **scan and fix**)

```bash
$ log-bosh
$ bosh tasks

ID       State       Started At                    Last Activity At              User    Deployment                  Description        Result
2215898  queued      Thu Jan  1 00:00:00 UTC 1970  Thu Jun  6 17:35:04 UTC 2019  hm      bosh-master                 scan and fix       -
```

- Check if some deployments are still in `unresponsive agent` state (don't select a specific deployment when using **log-bosh**)

```bash
$ log-bosh
$ bosh instances
```

- If so, you have to reconciliate bosh deployments with the iaas. Select target deployment with **log-bosh** (Ex: `concourse`) and reconciliate each instance in trouble with **bosh cck** (option **3: Recreate VM without waiting for processes to start**)

```bash
$ bosh -d <deployment_name> cck
```

>**Note:**  
> **Prometheus** deployment in **master-depls** regurlaly collect metrics on micro-bosh, so you can see increasing bosh tasks.  
> You can cancel these tasks with following command:  
>```bash
>$ tasks=$(bosh tasks | grep "prometheus" | awk '{print $1}')
>$ for t in $tasks ; do bosh cancel-task $t ; done
>```

- Generate credhub certs wich depend from `internalCA`

```bash
$ ~/bosh/template/admin/generate-certs-for-credub.sh
```

- Commit updated files to git secrets repository

```bash
$ cd ~/bosh/secrets
$ git status
$ git commit -a -m "update credhub certs"
$ git pull --rebase ; git push
```

- Unpause `micro-depls/micro-depls-bosh-generated/deploy-credhub-ha` concourse job (trigger it if needed), and wait it turns green to take into account new certs

>**Note:**  
> If `credhub-ha` deployment failed, you have to check if the deployment is in `unresponsive agent` state.  
> So you have to apply `bosh cck` process to reconciliate bosh deployment with the iaas (see preceeding modops).

### Step 3: Recreate other bosh-director with new certs

- Pause following concourse pipelines (to avoid that managed deployments lock the bosh-director deployment)
  - `master-depls/master-depls-bosh-generated`
  - `ops-depls/ops-depls-bosh-generated`
  - `coab-depls/coab-depls-bosh-generated`
  - `kubo-depls/kubo-depls-bosh-generated`

- Check that no current deployments are in progress in each concourse pipeline, otherwise cancel jobs

- From **docker-bosh-cli** or **inception** instance, execute following steps sequentially:

- Delete bosh-director **bosh-master** certs in credhub

```bash
$ ~/bosh/template/admin/delete-directors-certs.sh
```

- Trigger `micro-depls/micro-depls-bosh-generated/deploy-bosh-master` concourse job and wait it turns green

- Unpause `master-depls/master-depls-bosh-generated` concourse pipeline, trigger `retrigger-all-jobs` job in the pipeline and wait it turns green

- Check if some deployments managed by the bosh-director are in `unresponsive agent` state (don't select a specific deployment when using **log-bosh**)

```bash
$ log-bosh
$ bosh instances
```

- Delete bosh-directors **bosh-ops**, **bosh-coab** and **bosh-kubo** certs in credhub (execute following tasks for each bosh-director)

  ```bash
  $ ~/bosh/template/admin/delete-directors-certs.sh
  ```

- Trigger following concourse jobs and wait they turn green
  - `master-depls/master-depls-bosh-generated/deploy-bosh-ops`
  - `master-depls/master-depls-bosh-generated/deploy-bosh-coab`
  - `master-depls/master-depls-bosh-generated/deploy-bosh-kubo`

- Unpause following concourse pipeline, trigger `retrigger-all-jobs` job in each pipeline and wait all jobs turn green before processing next bosh-director pipeline
  - `ops-depls/ops-depls-bosh-generated`
  - `coab-depls/coab-depls-bosh-generated`
  - `kubo-depls/kubo-depls-bosh-generated`

>**Note:**  
> Some times, deployments don't trigger and stay in `pending` status (grey border on job).  
> In this case, you have to cancel task on the job and retrigger it.

- Check if some deployments managed by each bosh-director are in `unresponsive agent` state (don't select a specific deployment when using **log-bosh**)

```bash
$ log-bosh
$ bosh instances
```

- When all bosh-directors updated, check certificates expiration in credhub

```bash
$ ~/bosh/template/admin/check-expiry-certs.sh -e 180
$ ~/bosh/template/admin/check-pki-certs.sh
```

>**Note:**  
> `check-expiry-certs.sh` script could be use with **-a** parameter to check all certs (including coab instances)  
> ```bash
> $ ~/bosh/template/admin/check-expiry-certs.sh -e 180 -a
> ```

## Use case 2: Bosh specific deployment certs rotation

>**Note:**  
> Relates to all deployments except `cf`, `isolation-segment-internet` and `isolation-segment-intranet-2`  

- Check [prerequisites](##Prerequisites)

- From **docker-bosh-cli** or **inception** instance, delete bosh deployment certs in credhub

```bash
$ log-bosh
$ ~/bosh/template/admin/delete-deployment-certs.sh
```

- Trigger `deploy-<deployment_name>` concourse job and wait it turns green

>**Note:**  
> If the deployment failed, you have to check if it is in `unresponsive agent` state.  
> So you have to apply `bosh cck` process to reconciliate bosh deployment with the iaas.

## Use case 3: Internet auto-signed cert rotation

- Check [prerequisites](##Prerequisites)

- From **docker-bosh-cli** or **inception** instance, generate new `internet` key and cert

```bash
$ ~/bosh/template/admin/generate-internet-cert.sh
```

- Commit updated files to git secrets repository

```bash
$ cd ~/bosh/secrets
$ git status
$ git commit -a -m "update internet key and cert"
$ git pull --rebase ; git push
```

- Delete credhub cert and key

```bash
$ log-credhub

$ credhub d -n /secrets/certs/internet
```

- Trigger sequentially following concourse jobs and wait they turn green
  - `micro-depls/micro-depls-bosh-generated/deploy-credhub-seeder`
  - `master-depls/master-depls-bosh-generated/deploy-cf-internet-rps`

## Use case 4: External PKI certs rotation

### Requirements

- PKI dongle
- Access to PKI portal **with Internet Explorer**
- Check [prerequisites](##Prerequisites)

### Step 1: Generate Cert Service Request

- Generate CSR (Certificate signing Request) and private key for each certs

```bash
$ ~/bosh/template/admin/generate-pki-csr.sh
```

>**Notes :**  
Files (private key and CSR) are generated into **`~/bosh/secrets/shared/certs/*/ongoing`** directories  

- You can check CSR content (exemple for ops cert)

```bash
$ cd ~/bosh/secrets/shared/certs
$ openssl req -noout -text -in ops-certs/ongoing/server.csr
```

### Step 2a: Generate certificate from PKI portal

- Insert your PKI dongle inside your laptop
- Log to PKI portal **with Internet Explorer** web browser (it doesn't work with firefox)
- Create a new request (menu **`gestion certificats serveurs`**/**`création d'une demande`**)
- Click on `suivant` button

**Input fields :**

|Field                        |Value                                 |
|-----------------------------|--------------------------------------|
|Type de certificat           |Prod G2 - 2 ans                       |
|Adresse mail supplémentaire  |<ops_mailing_list>                    |
|Nom du serveur               |<Domain>                              |
|MC-CT chargé de votre demande|Select your MC-CT                     |
|CSR au format PKCS#10        |<CSR content from `server.csr` file>  |
|Commentaires                 |<domain_type> production domain       |

### Step 2b: Renew certificate from PKI portal

- Insert your PKI dongle inside your laptop
- Log to PKI portal **with Internet Explorer** web browser (it doesn't work with firefox)
- Select certificate (menu **`gestion certificats serveurs`**/**`gestion de mes certificats`**)
- Click on `renouveler` button
- Replace (if needed) CSR field

###	Step 3: Integrate certs into distribution

- Wait for mail to confirm your certificate creation

- for each created certificate:
  - Download the certificate (**`format PEM`**) from PKI portal (menu **`gestion certificats serveurs`**/**`gestion de mes certificats`**)
  - Rename downloaded certificate to **`server.crt`** and put it in **`~/bosh/secrets/shared/certs/<domain_type>/server.crt`** (cf. following table)
  - Move each private key **`server.key`** and csr file **`server.csr`** from **`~/bosh/secrets/shared/certs/<domain_type>/ongoing`** to **`~/bosh/secrets/shared/certs/<domain_type>`**

|Domain type |Comment             |Secrets directory                              |Concourse job to trigger                                                       |
|------------|--------------------|-----------------------------------------------|-------------------------------------------------------------------------------|
|CF API      |CF cli api          |`~/bosh/secrets/shared/certs/api-certs`        |`master-depls/master-depls-bosh-generated/deploy-cf`                           |
|APPS        |Application domain1 |`~/bosh/secrets/shared/certs/intranet-1-certs` |`master-depls/master-depls-bosh-generated/deploy-cf-rps`                       |
|APPS        |Application domain2 |`~/bosh/secrets/shared/certs/intranet-2-certs` |`master-depls/master-depls-bosh-generated/deploy-isolation-segment-intranet-2` |
|OPS         |Ops domain          |`~/bosh/secrets/shared/certs/ops-certs`        |`master-depls/master-depls-bosh-generated/deploy-ops-routing`                  |
|OSB         |Services domains    |`~/bosh/secrets/shared/certs/osb-certs`        |`master-depls/master-depls-bosh-generated/deploy-osb-routing`                  |

- Check all certificates

```bash
$ ~/bosh/template/admin/check-pki-certs.sh
```

- If certificate are valid, commit and push files **`server.key`**, **`server.csr`** and **`server.crt`** to secrets repository

```bash
$ cd ~/bosh/secrets
$ git status
$ git commit -a -m "update pki <domain_type> key and cert"
$ git pull --rebase ; git push
```

- Trigger concourse jobs which use certs (cf. preceeding table)

- Test certificates with curl tool or with your browser

```bash
$ curl -vvv https://test.<domain>
```
